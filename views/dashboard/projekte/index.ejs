<%- include('../../partials/admin-header') %>

<div class="dashboard-wrapper">
    <!-- Dashboard Content -->
    <div class="dashboard-content p-3 p-md-4">
      <!-- Filter & Aktionen -->
      <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 gap-3">
        <div>
          <h2 class="h4 mb-1">Projektverwaltung</h2>
          <p class="text-muted mb-md-0">Übersicht aller laufenden und abgeschlossenen Projekte</p>
        </div>
        <div class="d-flex flex-wrap gap-2">
          <div class="input-group">
            <span class="input-group-text bg-white border-end-0">
              <i class="fas fa-filter text-muted"></i>
            </span>
            <select class="form-select border-start-0 status-filter" id="statusFilter">
              <option value="" <% if (statusFilter === '') { %>selected<% } %>>Alle Status</option>
              <option value="neu" <% if (statusFilter === 'neu') { %>selected<% } %>>Neu</option>
              <option value="in_bearbeitung" <% if (statusFilter === 'in_bearbeitung') { %>selected<% } %>>In Bearbeitung</option>
              <option value="abgeschlossen" <% if (statusFilter === 'abgeschlossen') { %>selected<% } %>>Abgeschlossen</option>
              <option value="storniert" <% if (statusFilter === 'storniert') { %>selected<% } %>>Storniert</option>
            </select>
          </div>
          <a href="/dashboard/projekte/neu" class="btn btn-success">
            <i class="fas fa-plus me-2"></i>Neues Projekt
          </a>
        </div>
      </div>

      <!-- Ansichtstabs -->
      <ul class="nav nav-tabs mb-4" id="viewTab" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="list-tab" data-bs-toggle="tab" data-bs-target="#list-view" type="button" role="tab" aria-controls="list-view" aria-selected="true">
            <i class="fas fa-list me-2"></i>Liste
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="card-tab" data-bs-toggle="tab" data-bs-target="#card-view" type="button" role="tab" aria-controls="card-view" aria-selected="false">
            <i class="fas fa-th-large me-2"></i>Karten
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="kanban-tab" data-bs-toggle="tab" data-bs-target="#kanban-view" type="button" role="tab" aria-controls="kanban-view" aria-selected="false">
            <i class="fas fa-columns me-2"></i>Kanban
          </button>
        </li>
      </ul>

      <!-- Tab-Inhalte -->
      <div class="tab-content">
        <!-- Listen-Ansicht -->
        <div class="tab-pane fade show active" id="list-view" role="tabpanel" aria-labelledby="list-tab">
          <div class="card border-0 shadow-sm">
            <div class="card-body p-0">
              <!-- Desktop Table View - Hidden on Small Screens -->
              <div class="d-none d-md-block table-responsive">
                <table class="table table-hover datatable mb-0">
                  <thead class="table-light">
                    <tr>
                      <th scope="col">Projektname</th>
                      <th scope="col">Kunde</th>
                      <th scope="col">Start</th>
                      <th scope="col">Status</th>
                      <th scope="col">Betrag</th>
                      <th scope="col">Aktionen</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% if (typeof projects !== 'undefined' && projects.length > 0) { %>
                      <% projects.forEach(function(project) { %>
                        <tr>
                          <td>
                            <a href="/dashboard/projekte/<%= project.id %>" class="text-decoration-none text-dark fw-medium">
                              <%= project.titel %>
                            </a>
                          </td>
                          <td>
                            <% if (project.kunde_id) { %>
                              <a href="/dashboard/kunden/<%= project.kunde_id %>" class="text-decoration-none">
                                <%= project.kunde_name %>
                              </a>
                            <% } else { %>
                              <span class="text-muted">-</span>
                            <% } %>
                          </td>
                          <td><%= project.start_datum %></td>
                          <td>
                            <span class="badge bg-<%= project.statusClass %>">
                              <%= project.statusLabel %>
                            </span>
                          </td>
                          <td class="text-end">
                            <% if (project.betrag) { %>
                              € <%= project.betrag.toLocaleString('de-DE', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %>
                            <% } else { %>
                              -
                            <% } %>
                          </td>
                          <td>
                            <div class="btn-group btn-group-sm">
                              <a href="/dashboard/projekte/<%= project.id %>" class="btn btn-outline-secondary">
                                <i class="fas fa-eye"></i>
                              </a>
                              <a href="/dashboard/projekte/<%= project.id %>/edit" class="btn btn-outline-primary">
                                <i class="fas fa-edit"></i>
                              </a>
                              <button class="btn btn-outline-success status-toggle" 
                                data-bs-toggle="modal" 
                                data-bs-target="#statusModal" 
                                data-id="<%= project.id %>"
                                data-status="<%= project.status %>">
                                <i class="fas fa-check-circle"></i>
                              </button>
                            </div>
                          </td>
                        </tr>
                      <% }); %>
                    <% } else { %>
                      <tr>
                        <td colspan="6" class="text-center py-4">
                          <p class="text-muted mb-0">Keine Projekte gefunden</p>
                        </td>
                      </tr>
                    <% } %>
                  </tbody>
                </table>
              </div>

              <!-- Mobile Card View - Shown Only on Small Screens -->
              <div class="d-md-none">
                <% if (typeof projects !== 'undefined' && projects.length > 0) { %>
                  <div class="list-group list-group-flush">
                    <% projects.forEach(function(project) { %>
                      <div class="list-group-item p-3">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                          <h6 class="mb-0">
                            <a href="/dashboard/projekte/<%= project.id %>" class="text-decoration-none text-dark">
                              <%= project.titel %>
                            </a>
                          </h6>
                          <span class="badge bg-<%= project.statusClass %>">
                            <%= project.statusLabel %>
                          </span>
                        </div>
                        
                        <% if (project.kunde_id) { %>
                          <div class="mb-1 small">
                            <i class="fas fa-user text-muted me-1"></i> 
                            <a href="/dashboard/kunden/<%= project.kunde_id %>" class="text-decoration-none">
                              <%= project.kunde_name %>
                            </a>
                          </div>
                        <% } %>
                        
                        <div class="mb-1 small">
                          <i class="fas fa-calendar text-muted me-1"></i> Start: <%= project.start_datum %>
                        </div>
                        
                        <% if (project.end_datum && project.end_datum !== '-') { %>
                          <div class="mb-1 small">
                            <i class="fas fa-calendar-check text-muted me-1"></i> Ende: <%= project.end_datum %>
                          </div>
                        <% } %>
                        
                        <% if (project.betrag) { %>
                          <div class="mb-2 small">
                            <i class="fas fa-euro-sign text-muted me-1"></i> 
                            € <%= project.betrag.toLocaleString('de-DE', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %>
                          </div>
                        <% } %>
                        
                        <div class="d-flex justify-content-end gap-2 mt-2">
                          <a href="/dashboard/projekte/<%= project.id %>" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-eye"></i>
                          </a>
                          <a href="/dashboard/projekte/<%= project.id %>/edit" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-edit"></i>
                          </a>
                          <button class="btn btn-sm btn-outline-success status-toggle" 
                                  data-bs-toggle="modal" 
                                  data-bs-target="#statusModal" 
                                  data-id="<%= project.id %>"
                                  data-status="<%= project.status %>">
                            <i class="fas fa-check-circle"></i>
                          </button>
                        </div>
                      </div>
                    <% }); %>
                  </div>
                <% } else { %>
                  <div class="text-center py-4">
                    <p class="text-muted mb-0">Keine Projekte gefunden</p>
                  </div>
                <% } %>
              </div>
            </div>
          </div>
        </div>

        <!-- Karten-Ansicht -->
        <div class="tab-pane fade" id="card-view" role="tabpanel" aria-labelledby="card-tab">
          <div class="row g-3">
            <% if (typeof projects !== 'undefined' && projects.length > 0) { %>
              <% projects.forEach(function(project) { %>
                <div class="col-md-6 col-lg-4">
                  <div class="card h-100 border-0 shadow-sm">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                      <h3 class="h6 mb-0 text-truncate"><%= project.titel %></h3>
                      <span class="badge bg-<%= project.statusClass %> ms-2 flex-shrink-0">
                        <%= project.statusLabel %>
                      </span>
                    </div>
                    <div class="card-body">
                      <div class="mb-3">
                        <div class="small text-muted">Kunde</div>
                        <div class="fw-medium">
                          <% if (project.kunde_id) { %>
                            <a href="/dashboard/kunden/<%= project.kunde_id %>" class="text-decoration-none">
                              <%= project.kunde_name %>
                            </a>
                          <% } else { %>
                            <span class="text-muted">Nicht zugewiesen</span>
                          <% } %>
                        </div>
                      </div>
                      
                      <div class="row g-2 mb-3">
                        <div class="col-6">
                          <div class="small text-muted">Start</div>
                          <div><%= project.start_datum %></div>
                        </div>
                        <div class="col-6">
                          <div class="small text-muted">Ende</div>
                          <div><%= project.end_datum || '-' %></div>
                        </div>
                      </div>
                      
                      <div class="mb-3">
                        <div class="small text-muted">Dienstleistung</div>
                        <div><%= project.dienstleistung || 'Nicht angegeben' %></div>
                      </div>
                      
                      <% if (project.betrag) { %>
                        <div class="mb-3">
                          <div class="small text-muted">Betrag</div>
                          <div class="fw-medium">€ <%= project.betrag.toLocaleString('de-DE', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></div>
                        </div>
                      <% } %>
                      
                      <div class="d-flex justify-content-end gap-2 mt-3">
                        <a href="/dashboard/projekte/<%= project.id %>/edit" class="btn btn-sm btn-outline-primary">
                          <i class="fas fa-edit me-1"></i>Bearbeiten
                        </a>
                        <a href="/dashboard/projekte/<%= project.id %>" class="btn btn-sm btn-outline-secondary">
                          <i class="fas fa-eye me-1"></i>Details
                        </a>
                      </div>
                    </div>
                  </div>
                </div>
              <% }); %>
            <% } else { %>
              <div class="col-12">
                <div class="text-center py-5">
                  <i class="fas fa-project-diagram fa-3x text-muted mb-3"></i>
                  <h3 class="h5">Keine Projekte gefunden</h3>
                  <p class="text-muted">Erstellen Sie ein neues Projekt, um zu beginnen.</p>
                  <a href="/dashboard/projekte/neu" class="btn btn-success mt-2">
                    <i class="fas fa-plus me-2"></i>Neues Projekt
                  </a>
                </div>
              </div>
            <% } %>
          </div>
        </div>

        <!-- Kanban-Ansicht -->
        <div class="tab-pane fade" id="kanban-view" role="tabpanel" aria-labelledby="kanban-tab">
          <div class="row g-3 kanban-board" style="min-height: 500px; overflow-x: auto;">
            <div class="col-md-6 col-lg-3">
              <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white">
                  <div class="d-flex justify-content-between align-items-center">
                    <h4 class="h6 mb-0">Neu</h4>
                    <span class="badge bg-secondary rounded-pill">
                      <%= typeof projects !== 'undefined' ? projects.filter(p => p.status === 'neu').length : 0 %>
                    </span>
                  </div>
                </div>
                <div class="card-body p-2">
                  <div class="kanban-column" data-status="neu">
                    <% if (typeof projects !== 'undefined' && projects.length > 0) { %>
                      <% projects.filter(p => p.status === 'neu').forEach(function(project) { %>
                        <div class="card mb-2 kanban-item" data-id="<%= project.id %>">
                          <div class="card-body p-3">
                            <h5 class="h6 mb-2">
                              <a href="/dashboard/projekte/<%= project.id %>" class="text-decoration-none text-dark">
                                <%= project.titel %>
                              </a>
                            </h5>
                            <div class="small text-muted mb-2">
                              <i class="fas fa-user me-1"></i> <%= project.kunde_name || 'Kein Kunde' %>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                              <small class="text-muted"><%= project.start_datum %></small>
                              <button class="btn btn-sm btn-outline-secondary kanban-move" data-bs-toggle="modal" data-bs-target="#statusModal" data-id="<%= project.id %>">
                                <i class="fas fa-arrow-right"></i>
                              </button>
                            </div>
                          </div>
                        </div>
                      <% }); %>
                    <% } %>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="col-md-6 col-lg-3">
              <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white">
                  <div class="d-flex justify-content-between align-items-center">
                    <h4 class="h6 mb-0">In Bearbeitung</h4>
                    <span class="badge bg-info rounded-pill">
                      <%= typeof projects !== 'undefined' ? projects.filter(p => p.status === 'in_bearbeitung').length : 0 %>
                    </span>
                  </div>
                </div>
                <div class="card-body p-2">
                  <div class="kanban-column" data-status="in_bearbeitung">
                    <% if (typeof projects !== 'undefined' && projects.length > 0) { %>
                      <% projects.filter(p => p.status === 'in_bearbeitung').forEach(function(project) { %>
                        <div class="card mb-2 kanban-item" data-id="<%= project.id %>">
                          <div class="card-body p-3">
                            <h5 class="h6 mb-2">
                              <a href="/dashboard/projekte/<%= project.id %>" class="text-decoration-none text-dark">
                                <%= project.titel %>
                              </a>
                            </h5>
                            <div class="small text-muted mb-2">
                              <i class="fas fa-user me-1"></i> <%= project.kunde_name || 'Kein Kunde' %>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                              <small class="text-muted"><%= project.start_datum %></small>
                              <button class="btn btn-sm btn-outline-secondary kanban-move" data-bs-toggle="modal" data-bs-target="#statusModal" data-id="<%= project.id %>">
                                <i class="fas fa-arrow-right"></i>
                              </button>
                            </div>
                          </div>
                        </div>
                      <% }); %>
                    <% } %>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="col-md-6 col-lg-3">
              <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white">
                  <div class="d-flex justify-content-between align-items-center">
                    <h4 class="h6 mb-0">Abgeschlossen</h4>
                    <span class="badge bg-success rounded-pill">
                      <%= typeof projects !== 'undefined' ? projects.filter(p => p.status === 'abgeschlossen').length : 0 %>
                    </span>
                  </div>
                </div>
                <div class="card-body p-2">
                  <div class="kanban-column" data-status="abgeschlossen">
                    <% if (typeof projects !== 'undefined' && projects.length > 0) { %>
                      <% projects.filter(p => p.status === 'abgeschlossen').forEach(function(project) { %>
                        <div class="card mb-2 kanban-item" data-id="<%= project.id %>">
                          <div class="card-body p-3">
                            <h5 class="h6 mb-2">
                              <a href="/dashboard/projekte/<%= project.id %>" class="text-decoration-none text-dark">
                                <%= project.titel %>
                              </a>
                            </h5>
                            <div class="small text-muted mb-2">
                              <i class="fas fa-user me-1"></i> <%= project.kunde_name || 'Kein Kunde' %>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                              <small class="text-muted"><%= project.end_datum || '-' %></small>
                              <button class="btn btn-sm btn-outline-secondary kanban-move" data-bs-toggle="modal" data-bs-target="#statusModal" data-id="<%= project.id %>">
                                <i class="fas fa-arrow-right"></i>
                              </button>
                            </div>
                          </div>
                        </div>
                      <% }); %>
                    <% } %>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="col-md-6 col-lg-3">
              <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white">
                  <div class="d-flex justify-content-between align-items-center">
                    <h4 class="h6 mb-0">Storniert</h4>
                    <span class="badge bg-secondary rounded-pill">
                      <%= typeof projects !== 'undefined' ? projects.filter(p => p.status === 'storniert').length : 0 %>
                    </span>
                  </div>
                </div>
                <div class="card-body p-2">
                  <div class="kanban-column" data-status="storniert">
                    <% if (typeof projects !== 'undefined' && projects.length > 0) { %>
                      <% projects.filter(p => p.status === 'storniert').forEach(function(project) { %>
                        <div class="card mb-2 kanban-item" data-id="<%= project.id %>">
                          <div class="card-body p-3">
                            <h5 class="h6 mb-2">
                              <a href="/dashboard/projekte/<%= project.id %>" class="text-decoration-none text-dark">
                                <%= project.titel %>
                              </a>
                            </h5>
                            <div class="small text-muted mb-2">
                              <i class="fas fa-user me-1"></i> <%= project.kunde_name || 'Kein Kunde' %>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                              <small class="text-muted"><%= project.end_datum || '-' %></small>
                              <a href="/dashboard/projekte/<%= project.id %>" class="btn btn-sm btn-outline-secondary">
                                <i class="fas fa-eye"></i>
                              </a>
                            </div>
                          </div>
                        </div>
                      <% }); %>
                    <% } %>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>

<!-- Status Modal -->
<div class="modal fade" id="statusModal" tabindex="-1" aria-labelledby="statusModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="statusModalLabel">Projekt-Status ändern</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="statusForm" action="/dashboard/projekte/update-status" method="POST">
          <input type="hidden" name="_csrf" value="<%= csrfToken %>">
          <input type="hidden" id="projektId" name="id" value="">
          
          <div class="mb-3">
            <label for="status" class="form-label">Status</label>
            <select class="form-select" id="status" name="status" required>
              <option value="neu">Neu</option>
              <option value="in_bearbeitung">In Bearbeitung</option>
              <option value="abgeschlossen">Abgeschlossen</option>
              <option value="storniert">Storniert</option>
            </select>
          </div>
          
          <div class="mb-3">
            <label for="statusNote" class="form-label">Notiz (optional)</label>
            <textarea class="form-control" id="statusNote" name="note" rows="3"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Abbrechen</button>
        <button type="submit" form="statusForm" class="btn btn-success">Speichern</button>
      </div>
    </div>
  </div>
</div>

<style>
  /* Kanban-Board-Stile */
  .kanban-board {
    min-height: 500px;
  }
  
  .kanban-column {
    min-height: 400px;
    padding-bottom: 20px;
  }
  
  .kanban-item {
    cursor: grab;
  }
  
  .kanban-item:active {
    cursor: grabbing;
  }
  
  @media (max-width: 767.98px) {
    .kanban-board {
      overflow-x: auto;
      white-space: nowrap;
    }
    
    .kanban-board .col-md-6 {
      display: inline-block;
      float: none;
      width: 90%;
      white-space: normal;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Status Modal Funktionalität
    const statusModal = document.getElementById('statusModal');
    if (statusModal) {
      statusModal.addEventListener('show.bs.modal', function(event) {
        const button = event.relatedTarget;
        const projektId = button.getAttribute('data-id');
        const currentStatus = button.getAttribute('data-status');
        document.getElementById('projektId').value = projektId;
        const statusSelect = document.getElementById('status');
        if (currentStatus && statusSelect) {
          statusSelect.value = currentStatus;
        }
      });
    }
    
    // Kanban-Board Funktionalität - nur laden, wenn benötigt
    const kanbanTab = document.getElementById('kanban-tab');
    if (kanbanTab) {
      kanbanTab.addEventListener('shown.bs.tab', initDragAndDrop);
    }
    
    function initDragAndDrop() {
      // Nur laden, wenn Dragula verfügbar ist
      if (typeof dragula === 'undefined') {
        console.log('Dragula nicht geladen. Drag & Drop nicht verfügbar.');
        return;
      }
      
      const containers = Array.from(document.querySelectorAll('.kanban-column'));
      
      const drake = dragula(containers);
      
      drake.on('drop', function(el, target, source) {
        const projektId = el.getAttribute('data-id');
        const newStatus = target.getAttribute('data-status');
        const oldStatus = source.getAttribute('data-status');
        
        if (newStatus !== oldStatus) {
          // AJAX-Request zum Aktualisieren des Status
          updateProjectStatus(projektId, newStatus);
        }
      });
    }
    
    function updateProjectStatus(id, status) {
      // CSRF-Token aus dem Meta-Tag abrufen
      const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
      
      fetch('/dashboard/projekte/update-status', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'CSRF-Token': csrfToken
        },
        body: JSON.stringify({ id, status })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showToast('success', 'Status erfolgreich aktualisiert');
        } else {
          showToast('error', 'Fehler beim Aktualisieren des Status');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showToast('error', 'Fehler beim Aktualisieren des Status');
      });
    }
    
    function showToast(type, message) {
      const toastContainer = document.getElementById('toastContainer');
      if (!toastContainer) {
        const container = document.createElement('div');
        container.id = 'toastContainer';
        container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
        document.body.appendChild(container);
      }
      
      const toast = document.createElement('div');
      toast.className = `toast align-items-center border-0 bg-${type === 'success' ? 'success' : 'danger'} text-white`;
      toast.setAttribute('role', 'alert');
      toast.setAttribute('aria-live', 'assertive');
      toast.setAttribute('aria-atomic', 'true');
      toast.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">
            ${message}
          </div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      `;
      
      document.getElementById('toastContainer').appendChild(toast);
      const bsToast = new bootstrap.Toast(toast);
      bsToast.show();
    }
  });
</script>

<%- include('../../partials/admin-footer-simple') %>