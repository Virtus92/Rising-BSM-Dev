<%- include('../../partials/admin-header') %>

<div class="dashboard-wrapper">
  <!-- Sidebar Toggle Button (Mobile) -->
  <button id="sidebarToggle" class="btn btn-success d-md-none position-fixed top-0 end-0 mt-2 me-2 z-10">
    <i class="fas fa-bars"></i>
  </button>

  <!-- Sidebar -->
  <aside class="dashboard-sidebar bg-white shadow-sm">
    <div class="sidebar-header p-3 border-bottom">
      <img src="/images/Logo.png" alt="Rising BSM Logo" class="img-fluid" style="max-height: 50px;">
      <button id="sidebarClose" class="btn-close d-md-none"></button>
    </div>
    <div class="sidebar-user p-3 border-bottom">
      <div class="d-flex align-items-center">
        <div class="avatar-wrapper bg-success rounded-circle me-2">
          <span class="text-white fw-bold"><%= user.initials %></span>
        </div>
        <div class="user-info">
          <h6 class="mb-0 fw-semibold"><%= user.name %></h6>
          <small class="text-muted"><%= user.role %></small>
        </div>
      </div>
    </div>
    <nav class="sidebar-nav p-3">
      <ul class="list-unstyled mb-0">
        <li class="nav-item mb-2">
          <a href="/dashboard" class="nav-link <%= currentPath === '/dashboard' ? 'active' : '' %> px-3 py-2 rounded">
            <i class="fas fa-tachometer-alt me-2"></i> Dashboard
          </a>
        </li>
        <li class="nav-item mb-2">
          <a href="/dashboard/anfragen" class="nav-link <%= currentPath === '/dashboard/anfragen' ? 'active' : '' %> px-3 py-2 rounded">
            <i class="fas fa-envelope me-2"></i> Anfragen
            <% if (typeof newRequestsCount !== 'undefined' && newRequestsCount > 0) { %>
              <span class="badge bg-success rounded-pill ms-auto"><%= newRequestsCount %></span>
            <% } %>
          </a>
        </li>
        <li class="nav-item mb-2">
          <a href="/dashboard/kunden" class="nav-link <%= currentPath === '/dashboard/kunden' ? 'active' : '' %> px-3 py-2 rounded">
            <i class="fas fa-users me-2"></i> Kunden
          </a>
        </li>
        <li class="nav-item mb-2">
          <a href="/dashboard/termine" class="nav-link <%= currentPath === '/dashboard/termine' ? 'active' : '' %> px-3 py-2 rounded">
            <i class="fas fa-calendar-alt me-2"></i> Termine
          </a>
        </li>
        <li class="nav-item mb-2">
          <a href="/dashboard/dienste" class="nav-link <%= currentPath === '/dashboard/dienste' ? 'active' : '' %> px-3 py-2 rounded">
            <i class="fas fa-tools me-2"></i> Dienstleistungen
          </a>
        </li>
        <li class="nav-item mb-2">
          <a href="/dashboard/settings" class="nav-link <%= currentPath === '/dashboard/settings' ? 'active' : '' %> px-3 py-2 rounded">
            <i class="fas fa-cog me-2"></i> Einstellungen
          </a>
        </li>
        <li class="nav-item mt-4">
          <a href="/dashboard/logout" class="nav-link text-danger px-3 py-2 rounded">
            <i class="fas fa-sign-out-alt me-2"></i> Abmelden
          </a>
        </li>
      </ul>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="dashboard-main bg-light">
    <!-- Top Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm py-2 sticky-top">
      <div class="container-fluid">
        <h1 class="h5 mb-0 fw-bold">Termin Details</h1>
        <div class="d-flex align-items-center gap-3">
          <div class="dropdown">
            <button class="btn btn-link text-dark dropdown-toggle d-flex align-items-center gap-2" type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
              <div class="avatar-wrapper bg-success rounded-circle">
                <span class="text-white fw-bold"><%= user.initials %></span>
              </div>
              <span class="d-none d-lg-inline"><%= user.name %></span>
            </button>
            <ul class="dropdown-menu dropdown-menu-end shadow-sm" aria-labelledby="userDropdown">
              <li><a class="dropdown-item" href="/dashboard/profile"><i class="fas fa-user me-2"></i> Profil</a></li>
              <li><a class="dropdown-item" href="/dashboard/settings"><i class="fas fa-cog me-2"></i> Einstellungen</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item text-danger" href="/dashboard/logout"><i class="fas fa-sign-out-alt me-2"></i> Abmelden</a></li>
            </ul>
          </div>
        </div>
      </div>
    </nav>

    <!-- Dashboard Content -->
    <div class="dashboard-content p-3 p-md-4">
      <!-- Breadcrumb -->
      <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="/dashboard">Dashboard</a></li>
          <li class="breadcrumb-item"><a href="/dashboard/termine">Termine</a></li>
          <li class="breadcrumb-item active" aria-current="page">Termin #<%= termin.id %></li>
        </ol>
      </nav>

      <% if (messages.success && messages.success.length > 0) { %>
        <div class="alert alert-success alert-dismissible fade show" role="alert">
          <i class="fas fa-check-circle me-2"></i><%= messages.success %>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      <% } %>
      
      <% if (messages.error && messages.error.length > 0) { %>
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
          <i class="fas fa-exclamation-circle me-2"></i><%= messages.error %>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      <% } %>

      <!-- Termin Details Cards -->
      <div class="row g-4">
        <div class="col-lg-8">
          <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
              <h2 class="h5 mb-0">Termin Details</h2>
              <span class="badge bg-<%= termin.statusClass %>">
                <%= termin.statusLabel %>
              </span>
            </div>
            <div class="card-body">
              <div class="row mb-4">
                <div class="col-md-6">
                  <h3 class="h6 text-muted mb-2">Titel</h3>
                  <p class="mb-0 fw-semibold"><%= termin.titel %></p>
                </div>
                <div class="col-md-6">
                  <h3 class="h6 text-muted mb-2">Kunde</h3>
                  <p class="mb-0">
                    <% if (termin.kunde_id) { %>
                      <a href="/dashboard/kunden/<%= termin.kunde_id %>" class="text-decoration-none"><%= termin.kunde_name %></a>
                    <% } else { %>
                      <%= termin.kunde_name %>
                    <% } %>
                  </p>
                </div>
              </div>
              
              <div class="row mb-4">
                <div class="col-md-4">
                  <h3 class="h6 text-muted mb-2">Datum</h3>
                  <p class="mb-0"><%= termin.dateFormatted %></p>
                </div>
                <div class="col-md-4">
                  <h3 class="h6 text-muted mb-2">Uhrzeit</h3>
                  <p class="mb-0"><%= termin.timeFormatted %> Uhr</p>
                </div>
                <div class="col-md-4">
                  <h3 class="h6 text-muted mb-2">Dauer</h3>
                  <p class="mb-0"><%= termin.dauer %> Minuten</p>
                </div>
              </div>
              
              <div class="row mb-4">
                <div class="col-12">
                  <h3 class="h6 text-muted mb-2">Ort</h3>
                  <p class="mb-0"><%= termin.ort %></p>
                </div>
              </div>
              
              <div class="row">
                <div class="col-12">
                  <h3 class="h6 text-muted mb-2">Beschreibung</h3>
                  <div class="p-3 bg-light rounded">
                    <%= termin.beschreibung %>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Notizen -->
          <div class="card border-0 shadow-sm">
            <div class="card-header bg-white">
              <h2 class="h5 mb-0">Notizen</h2>
            </div>
            <div class="card-body">
              <% if (typeof notizen !== 'undefined' && notizen.length > 0) { %>
                <div class="timeline">
                  <% notizen.forEach(function(notiz) { %>
                    <div class="timeline-item">
                      <div class="timeline-marker bg-success"></div>
                      <div class="timeline-content">
                        <div class="d-flex justify-content-between mb-2">
                          <span class="fw-semibold"><%= notiz.benutzer %></span>
                          <small class="text-muted"><%= notiz.formattedDate %></small>
                        </div>
                        <p class="mb-0"><%= notiz.text %></p>
                      </div>
                    </div>
                  <% }); %>
                </div>
              <% } else { %>
                <p class="text-muted">Keine Notizen vorhanden.</p>
              <% } %>
              
              <!-- Neue Notiz Form -->
              <form action="/dashboard/termine/add-note" method="POST" class="mt-4">
                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                <input type="hidden" name="id" value="<%= termin.id %>">
                
                <div class="mb-3">
                  <label for="noteText" class="form-label">Neue Notiz</label>
                  <textarea class="form-control" id="noteText" name="note" rows="3" required></textarea>
                </div>
                
                <button type="submit" class="btn btn-success">
                  <i class="fas fa-plus me-2"></i>Notiz hinzuf√ºgen
                </button>
              </form>
            </div>
          </div>
        </div>
        
        <div class="col-lg-4">
          <!-- Aktionen Card -->
          <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white">
              <h2 class="h5 mb-0">Aktionen</h2>
            </div>
            <div class="card-body">
              <button class="btn btn-primary w-100 mb-3" data-bs-toggle="modal" data-bs-target="#statusModal">
                <i class="fas fa-edit me-2"></i>Status √§ndern
              </button>
              
              <a href="/dashboard/termine/<%= termin.id %>/edit" class="btn btn-success w-100 mb-3">
                <i class="fas fa-pencil-alt me-2"></i>Termin bearbeiten
              </a>
              
              <% if (termin.kunde_id) { %>
                <a href="/dashboard/kunden/<%= termin.kunde_id %>" class="btn btn-info w-100 mb-3 text-white">
                  <i class="fas fa-user me-2"></i>Kundendetails anzeigen
                </a>
              <% } %>
              
              <a href="javascript:window.print()" class="btn btn-outline-secondary w-100">
                <i class="fas fa-print me-2"></i>Termin drucken
              </a>
            </div>
          </div>
          
          <!-- Infokarte -->
          <div class="card border-0 shadow-sm">
            <div class="card-header bg-white">
              <h2 class="h5 mb-0">Termin-Kalender</h2>
            </div>
            <div class="card-body">
              <div class="calendar-preview mb-3">
                <div class="calendar-header text-center bg-light p-2 rounded">
                  <%= new Date(termin.termin_datum).toLocaleString('de-DE', { month: 'long', year: 'numeric' }) %>
                </div>
                <div class="calendar-body p-3 text-center">
                  <div class="calendar-date">
                    <span class="display-4 fw-bold"><%= new Date(termin.termin_datum).getDate() %></span>
                    <p class="mb-0"><%= new Date(termin.termin_datum).toLocaleString('de-DE', { weekday: 'long' }) %></p>
                  </div>
                  <div class="calendar-time mt-3">
                    <span class="badge bg-<%= termin.statusClass %> p-2"><%= termin.timeFormatted %> Uhr</span>
                  </div>
                </div>
              </div>
              
              <a href="/dashboard/termine" class="btn btn-outline-secondary w-100">
                <i class="fas fa-calendar-alt me-2"></i>Zum Kalender
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>

<!-- Status Modal -->
<div class="modal fade" id="statusModal" tabindex="-1" aria-labelledby="statusModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="statusModalLabel">Termin-Status √§ndern</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="statusForm" action="/dashboard/termine/update-status" method="POST">
          <input type="hidden" name="_csrf" value="<%= csrfToken %>">
          <input type="hidden" name="id" value="<%= termin.id %>">
          
          <div class="mb-3">
            <label for="status" class="form-label">Status</label>
            <select class="form-select" id="status" name="status" required>
              <option value="geplant" <%= termin.status === 'geplant' ? 'selected' : '' %>>Geplant</option>
              <option value="bestaetigt" <%= termin.status === 'bestaetigt' ? 'selected' : '' %>>Best√§tigt</option>
              <option value="abgeschlossen" <%= termin.status === 'abgeschlossen' ? 'selected' : '' %>>Abgeschlossen</option>
              <option value="storniert" <%= termin.status === 'storniert' ? 'selected' : '' %>>Storniert</option>
            </select>
          </div>
          
          <div class="mb-3">
            <label for="note" class="form-label">Notiz (optional)</label>
            <textarea class="form-control" id="note" name="note" rows="3"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Abbrechen</button>
        <button type="submit" form="statusForm" class="btn btn-success">Speichern</button>
      </div>
    </div>
  </div>
</div>

<style>
  /* Timeline Styles */
  .timeline {
    position: relative;
    padding-left: 1.5rem;
  }
  
  .timeline:before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    height: 100%;
    width: 2px;
    background-color: #e9ecef;
  }
  
  .timeline-item {
    position: relative;
    padding-bottom: 1.5rem;
  }
  
  .timeline-marker {
    position: absolute;
    left: -1.5rem;
    top: 0;
    width: 1rem;
    height: 1rem;
    border-radius: 50%;
  }
  
  .timeline-content {
    background-color: #f8f9fa;
    padding: 1rem;
    border-radius: 0.25rem;
  }
  
  /* Calendar Styles */
  .calendar-preview {
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
  }
  
  .calendar-date {
    line-height: 1;
  }
  
  @media print {
    .dashboard-sidebar, .navbar, #statusModal, form, .btn {
      display: none !important;
    }
    
    .dashboard-main {
      margin-left: 0 !important;
      width: 100% !important;
    }
    
    .card {
      break-inside: avoid;
    }
  }
</style>

<%- include('../../partials/admin-footer-simple') %>