<%- include('../partials/admin-header') %>

<!-- Analytics Summary Cards -->
<div class="row g-3 mb-4">
  <!-- Optimierte Statistik-Karten mit Animation und Icons -->
  <div class="col-12 col-md-6 col-lg-3">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-3">
          <h6 class="card-title mb-0 text-muted">Neue Anfragen</h6>
          <div class="rounded-circle bg-primary bg-opacity-10 p-2">
            <i class="fas fa-envelope text-primary"></i>
          </div>
        </div>
        <h2 class="fw-bold mb-1 fs-4" id="newRequestsCounter"><%= stats.newRequests.count %></h2>
        <p class="<%= stats.newRequests.trend > 0 ? 'text-success' : (stats.newRequests.trend < 0 ? 'text-danger' : 'text-muted') %> small mb-0">
          <% if (stats.newRequests.trend !== 0) { %>
            <i class="fas fa-arrow-<%= stats.newRequests.trend > 0 ? 'up' : 'down' %> me-1"></i> <%= Math.abs(stats.newRequests.trend) %>% seit letzter Woche
          <% } else { %>
            <i class="fas fa-minus me-1"></i> Keine Änderung
          <% } %>
        </p>
        <div class="mt-3">
          <a href="/dashboard/anfragen?status=neu" class="btn btn-sm btn-outline-primary w-100">Alle anzeigen</a>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Remaining cards with the same pattern -->
  <div class="col-12 col-md-6 col-lg-3">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-3">
          <h6 class="card-title mb-0 text-muted">Aktive Aufträge</h6>
          <div class="rounded-circle bg-success bg-opacity-10 p-2">
            <i class="fas fa-tasks text-success"></i>
          </div>
        </div>
        <h2 class="fw-bold mb-1 fs-4" id="activeProjectsCounter"><%= stats.activeProjects.count %></h2>
        <p class="<%= stats.activeProjects.trend > 0 ? 'text-success' : (stats.activeProjects.trend < 0 ? 'text-danger' : 'text-muted') %> small mb-0">
          <% if (stats.activeProjects.trend !== 0) { %>
            <i class="fas fa-arrow-<%= stats.activeProjects.trend > 0 ? 'up' : 'down' %> me-1"></i> <%= Math.abs(stats.activeProjects.trend) %>% seit letztem Monat
          <% } else { %>
            <i class="fas fa-minus me-1"></i> Keine Änderung
          <% } %>
        </p>
        <div class="mt-3">
          <a href="/dashboard/projekte?status=in_bearbeitung" class="btn btn-sm btn-outline-success w-100">Details anzeigen</a>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-12 col-md-6 col-lg-3">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-3">
          <h6 class="card-title mb-0 text-muted">Gesamtkunden</h6>
          <div class="rounded-circle bg-info bg-opacity-10 p-2">
            <i class="fas fa-users text-info"></i>
          </div>
        </div>
        <h2 class="fw-bold mb-1 fs-4" id="activeCustomersCounter"><%= stats.totalCustomers.count %></h2>
        <p class="<%= stats.totalCustomers.trend > 0 ? 'text-success' : (stats.totalCustomers.trend < 0 ? 'text-danger' : 'text-muted') %> small mb-0">
          <% if (stats.totalCustomers.trend !== 0) { %>
            <i class="fas fa-arrow-<%= stats.totalCustomers.trend > 0 ? 'up' : 'down' %> me-1"></i> <%= Math.abs(stats.totalCustomers.trend) %>% im Jahresvergleich
          <% } else { %>
            <i class="fas fa-minus me-1"></i> Keine Änderung
          <% } %>
        </p>
        <div class="mt-3">
          <a href="/dashboard/kunden" class="btn btn-sm btn-outline-info w-100">Kundenliste</a>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-12 col-md-6 col-lg-3">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-3">
          <h6 class="card-title mb-0 text-muted">Umsatz (Monat)</h6>
          <div class="rounded-circle bg-warning bg-opacity-10 p-2">
            <i class="fas fa-euro-sign text-warning"></i>
          </div>
        </div>
        <h2 class="fw-bold mb-1 fs-4">€<span id="monthlyRevenueCounter"><%= stats.monthlyRevenue.amount.toLocaleString('de-DE') %></span></h2>
        <p class="<%= stats.monthlyRevenue.trend > 0 ? 'text-success' : (stats.monthlyRevenue.trend < 0 ? 'text-danger' : 'text-muted') %> small mb-0">
          <% if (stats.monthlyRevenue.trend !== 0) { %>
            <i class="fas fa-arrow-<%= stats.monthlyRevenue.trend > 0 ? 'up' : 'down' %> me-1"></i> <%= Math.abs(stats.monthlyRevenue.trend) %>% seit letztem Monat
          <% } else { %>
            <i class="fas fa-minus me-1"></i> Keine Änderung
          <% } %>
        </p>
        <div class="mt-3">
          <a href="#" class="btn btn-sm btn-outline-warning w-100">Umsatzdetails</a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Charts Row mit verbesserten Filtern und Interaktivität -->
<div class="row g-3 mb-4">
  <div class="col-12 col-lg-8">
    <div class="card border-0 shadow-sm">
      <div class="card-header bg-white">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">Umsatzentwicklung</h5>
          <div class="d-flex align-items-center">
            <select class="form-select form-select-sm me-2" id="periodFilter">
              <% chartFilters.revenue.options.forEach(function(option) { %>
                <option value="<%= option.toLowerCase().replace(/\s+/g, '') %>" <%= option === chartFilters.revenue.selected ? 'selected' : '' %>><%= option %></option>
              <% }); %>
            </select>
            <div class="dropdown">
              <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="chartOptionsDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fas fa-ellipsis-v"></i>
              </button>
              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="chartOptionsDropdown">
                <li><a class="dropdown-item" href="#" id="downloadChartBtn"><i class="fas fa-download me-2"></i>Herunterladen</a></li>
                <li><a class="dropdown-item" href="#" id="printChartBtn"><i class="fas fa-print me-2"></i>Drucken</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="#" id="refreshChartBtn"><i class="fas fa-sync me-2"></i>Aktualisieren</a></li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      <div class="card-body">
        <% if (charts.revenue.data.length === 0) { %>
          <div class="d-flex justify-content-center align-items-center py-5">
            <div class="text-center">
              <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
              <p class="text-muted">Keine Umsatzdaten verfügbar</p>
            </div>
          </div>
        <% } else { %>
          <div class="position-relative" style="height: 300px;">
            <canvas id="revenueChart"></canvas>
          </div>
          
          <!-- Make chart data available to the JavaScript -->
          <script>
            const revenueChartData = {
              labels: <%- JSON.stringify(charts.revenue.labels) %>,
              data: <%- JSON.stringify(charts.revenue.data) %>
            };
          </script>
        <% } %>
        
        <div class="d-flex justify-content-end align-items-center mt-2 text-muted">
          <small>Aktualisiert vor <span id="lastUpdateTime">0</span> Min. • Nächste: <span id="dashboardRefreshTime">5:00</span></small>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-12 col-lg-4">
    <div class="card border-0 shadow-sm">
      <div class="card-header bg-white">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">Aufträge nach Service</h5>
          <div class="dropdown">
            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="servicesTimeDropdown" data-bs-toggle="dropdown" aria-expanded="false">
              <%= chartFilters.services.selected %>
            </button>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="servicesTimeDropdown">
              <% chartFilters.services.options.forEach(function(option) { %>
                <li><a class="dropdown-item <%= option === chartFilters.services.selected ? 'active' : '' %>"
                       href="/dashboard?servicesFilter=<%= encodeURIComponent(option) %>"><%= option %></a></li>
              <% }); %>
            </ul>
          </div>
        </div>
      </div>
      <div class="card-body">
        <% if (charts.services.data.length === 0) { %>
          <div class="d-flex justify-content-center align-items-center py-5">
            <div class="text-center">
              <i class="fas fa-chart-pie fa-3x text-muted mb-3"></i>
              <p class="text-muted">Keine Service-Daten verfügbar</p>
            </div>
          </div>
        <% } else { %>
          <div class="position-relative" style="height: 300px;">
            <canvas id="servicesChart"></canvas>
          </div>
          
          <!-- Make chart data available to the JavaScript -->
          <script>
            const servicesChartData = {
              labels: <%- JSON.stringify(charts.services.labels) %>,
              data: <%- JSON.stringify(charts.services.data) %>
            };
          </script>
        <% } %>
      </div>
    </div>
  </div>
</div>

<!-- Verbesserte Ansicht für Anfragen und Termine -->
<div class="row g-3">
  <!-- Recent Inquiries mit verbesserten Interaktionsmöglichkeiten -->
  <div class="col-12 col-lg-6">
    <div class="card border-0 shadow-sm">
      <div class="card-header bg-white">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">Neue Anfragen</h5>
          <div class="d-flex">
            <a href="/dashboard/anfragen/neu" class="btn btn-sm btn-success me-2">
              <i class="fas fa-plus me-1"></i>Neu
            </a>
            <a href="/dashboard/anfragen" class="btn btn-sm btn-outline-secondary">
              Alle anzeigen
            </a>
          </div>
        </div>
      </div>
      <div class="card-body p-0">
        <!-- Desktop Table View - Hidden on Small Screens -->
        <div class="d-none d-md-block table-responsive">
      <table class="table table-hover datatable mb-0">
        <thead class="table-light">
          <tr>
        <th scope="col">Name</th>
        <th scope="col">Service</th>
        <th scope="col">Datum</th>
        <th scope="col">Status</th>
        <th scope="col">Aktionen</th>
          </tr>
        </thead>
        <tbody>
          <% if (typeof recentRequests !== 'undefined' && recentRequests.length > 0) { %>
        <% recentRequests.forEach(function(request) { %>
          <tr>
            <td>
          <a href="/dashboard/anfragen/<%= request.id %>" class="text-decoration-none text-dark">
            <%= request.name %>
          </a>
            </td>
            <td><%= request.serviceLabel %></td>
            <td><%= request.formattedDate %></td>
            <td>
          <span class="badge bg-<%= request.statusClass %><%= request.status === 'Neu' ? ' text-dark' : '' %>">
            <%= request.status %>
          </span>
            </td>
            <td>
          <div class="btn-group btn-group-sm">
            <a href="/dashboard/anfragen/<%= request.id %>" class="btn btn-outline-secondary">
              <i class="fas fa-eye"></i>
            </a>
            <a href="/dashboard/kunden/neu?name=<%= encodeURIComponent(request.name) %>&email=<%= encodeURIComponent(request.email) %>" class="btn btn-outline-success" title="Kunde erstellen">
              <i class="fas fa-user-plus"></i>
            </a>
          </div>
            </td>
          </tr>
        <% }); %>
          <% } else { %>
        <tr>
          <td colspan="5" class="text-center py-4">
            <p class="text-muted mb-0">Keine Anfragen gefunden</p>
          </td>
        </tr>
          <% } %>
        </tbody>
      </table>
        </div>
        
        <!-- Mobile Card View - Shown Only on Small Screens -->
        <div class="d-md-none">
      <% if (typeof recentRequests !== 'undefined' && recentRequests.length > 0) { %>
        <div class="list-group list-group-flush">
          <% recentRequests.forEach(function(request) { %>
        <div class="list-group-item p-3">
          <div class="d-flex flex-column gap-2">
            <div class="d-flex justify-content-between align-items-start">
          <h6 class="mb-0">
            <a href="/dashboard/anfragen/<%= request.id %>" class="text-decoration-none text-dark">
              <%= request.name %>
            </a>
          </h6>
          <span class="badge bg-<%= request.statusClass %><%= request.status === 'Neu' ? ' text-dark' : '' %>">
            <%= request.status %>
          </span>
            </div>
            <div>
          <small class="text-muted">Service: <%= request.serviceLabel %></small>
            </div>
            <div>
          <small class="text-muted">Datum: <%= request.formattedDate %></small>
            </div>
            <div class="d-flex justify-content-end gap-2 mt-2">
          <a href="/dashboard/anfragen/<%= request.id %>" class="btn btn-sm btn-outline-secondary">
            <i class="fas fa-eye"></i>
          </a>
          <a href="/dashboard/kunden/neu?name=<%= encodeURIComponent(request.name) %>&email=<%= encodeURIComponent(request.email) %>" class="btn btn-sm btn-outline-success" title="Kunde erstellen">
            <i class="fas fa-user-plus"></i>
          </a>
            </div>
          </div>
        </div>
          <% }); %>
        </div>
      <% } else { %>
        <div class="text-center py-4">
          <p class="text-muted mb-0">Keine Anfragen gefunden</p>
        </div>
      <% } %>
        </div>
      </div>
    </div>
  </div>

  <!-- Upcoming Tasks/Appointments mit Kalenderintegration -->
  <div class="col-12 col-lg-6">
    <div class="card border-0 shadow-sm">
      <div class="card-header bg-white">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">Anstehende Termine</h5>
          <div class="d-flex">
            <a href="/dashboard/termine/neu" class="btn btn-sm btn-success me-2">
              <i class="fas fa-plus me-1"></i>Neu
            </a>
            <a href="/dashboard/termine" class="btn btn-sm btn-outline-secondary">
              Alle anzeigen
            </a>
          </div>
        </div>
      </div>
      <div class="card-body p-0">
        <% if (!upcomingAppointments || upcomingAppointments.length === 0) { %>
          <div class="p-4 text-center">
            <i class="fas fa-calendar-alt fa-3x text-muted mb-3"></i>
            <p class="text-muted mb-0">Keine anstehenden Termine</p>
            <a href="/dashboard/termine/neu" class="btn btn-sm btn-success mt-3">
              <i class="fas fa-plus me-1"></i> Termin erstellen
            </a>
          </div>
        <% } else { %>
          <div class="list-group list-group-flush">
            <% upcomingAppointments.forEach(function(appointment) { %>
              <div class="list-group-item p-3">
                <div class="d-flex w-100 justify-content-between align-items-center">
                  <div class="d-flex align-items-center">
                    <div class="me-3 text-center">
                      <div class="bg-<%= appointment.dateClass %> bg-opacity-10 p-2 rounded">
                        <span class="d-block text-<%= appointment.dateClass %> fw-bold"
                              style="min-width: 40px; font-size: 1.1rem;">
                          <%= appointment.dateLabel === 'Heute' || appointment.dateLabel === 'Morgen' ? 
                              appointment.dateLabel.substring(0, 1) : appointment.dateLabel.split('.')[0] %>
                        </span>
                        <small class="text-muted"><%= appointment.time %></small>
                      </div>
                    </div>
                    
                    <div>
                      <h6 class="mb-1">
                        <a href="/dashboard/termine/<%= appointment.id %>" class="text-decoration-none text-dark">
                          <%= appointment.title %>
                        </a>
                      </h6>
                      <p class="mb-0 text-muted small"><i class="fas fa-user-circle me-1"></i> <%= appointment.customer %></p>
                    </div>
                  </div>
                  <div>
                    <a href="/dashboard/termine/<%= appointment.id %>" class="btn btn-sm btn-outline-secondary">
                      <i class="fas fa-eye"></i>
                    </a>
                  </div>
                </div>
              </div>
            <% }); %>
          </div>
        <% } %>
      </div>
    </div>
  </div>
</div>

<!-- Erweiterte Dashboard-Funktionen - Quick Actions und System Status -->
<div class="row g-3 mt-2">
  <div class="col-12 col-lg-6">
    <div class="card border-0 shadow-sm">
      <div class="card-header bg-white">
        <h5 class="card-title mb-0">Schnellzugriff</h5>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-6 col-md-3">
            <a href="/dashboard/kunden/neu" class="text-decoration-none">
              <div class="d-flex flex-column align-items-center p-3 bg-light rounded">
                <i class="fas fa-user-plus fa-2x text-primary mb-2"></i>
                <span class="text-center">Neuer Kunde</span>
              </div>
            </a>
          </div>
          <div class="col-6 col-md-3">
            <a href="/dashboard/projekte/neu" class="text-decoration-none">
              <div class="d-flex flex-column align-items-center p-3 bg-light rounded">
                <i class="fas fa-project-diagram fa-2x text-success mb-2"></i>
                <span class="text-center">Neues Projekt</span>
              </div>
            </a>
          </div>
          <div class="col-6 col-md-3">
            <a href="/dashboard/termine/neu" class="text-decoration-none">
              <div class="d-flex flex-column align-items-center p-3 bg-light rounded">
                <i class="fas fa-calendar-plus fa-2x text-info mb-2"></i>
                <span class="text-center">Neuer Termin</span>
              </div>
            </a>
          </div>
          <div class="col-6 col-md-3">
            <a href="/dashboard/dienste" class="text-decoration-none">
              <div class="d-flex flex-column align-items-center p-3 bg-light rounded">
                <i class="fas fa-tools fa-2x text-warning mb-2"></i>
                <span class="text-center">Dienstleistungen</span>
              </div>
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-12 col-lg-6">
    <div class="card border-0 shadow-sm">
      <div class="card-header bg-white">
        <h5 class="card-title mb-0">System Status</h5>
      </div>
      <div class="card-body p-0">
        <ul class="list-group list-group-flush">
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <div>
              <i class="fas fa-server text-success me-2"></i> Datenbank
            </div>
            <span class="badge bg-success rounded-pill">Online</span>
          </li>
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <div>
              <i class="fas fa-tasks text-success me-2"></i> Auftragsverarbeitung
            </div>
            <span class="badge bg-success rounded-pill">Aktiv</span>
          </li>
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <div>
              <i class="fas fa-sync text-success me-2"></i> Letztes Update
            </div>
            <span>Heute, <%= new Date().toLocaleTimeString('de-DE', {hour: '2-digit', minute:'2-digit'}) %> Uhr</span>
          </li>
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <div>
              <i class="fas fa-chart-pie text-primary me-2"></i> Statistikmodul
            </div>
            <span class="badge bg-primary rounded-pill">Aktiv</span>
          </li>
        </ul>
      </div>
    </div>
  </div>
</div>
<%- include('../partials/admin-footer') %>
<!-- Chart.js laden -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<!-- Optimierte Dashboard-Funktionen -->
<script>
  // Optimierte Chart-Initialisierung mit besserer Konfiguration
  function initDashboardCharts() {
    // Revenue Chart
    const revenueChartEl = document.getElementById('revenueChart');
    if (revenueChartEl && typeof Chart !== 'undefined' && typeof revenueChartData !== 'undefined') {
      const revenueChart = new Chart(revenueChartEl, {
        type: 'line',
        data: {
          labels: revenueChartData.labels || [],
          datasets: [{
            label: 'Umsatz',
            data: revenueChartData.data || [],
            borderColor: '#198754',
            backgroundColor: 'rgba(25, 135, 84, 0.1)',
            tension: 0.3,
            fill: true,
            borderWidth: 2,
            pointBackgroundColor: '#198754',
            pointRadius: 4,
            pointHoverRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              mode: 'index',
              intersect: false,
              callbacks: {
                label: function(context) {
                  return '€' + context.parsed.y.toLocaleString('de-DE', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                  });
                }
              },
              backgroundColor: 'rgba(0, 0, 0, 0.7)',
              titleFont: {
                size: 13
              },
              bodyFont: {
                size: 12
              },
              padding: 10,
              cornerRadius: 4
            }
          },
          hover: {
            mode: 'nearest',
            intersect: false
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return '€' + value.toLocaleString('de-DE');
                },
                font: {
                  size: 11
                }
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.05)',
                drawBorder: false
              }
            },
            x: {
              grid: {
                display: false
              },
              ticks: {
                font: {
                  size: 11
                }
              }
            }
          }
        }
      });
    }

    // Services Chart - Doughnut Chart
    const servicesChartEl = document.getElementById('servicesChart');
    if (servicesChartEl && typeof Chart !== 'undefined' && typeof servicesChartData !== 'undefined') {
      const servicesChart = new Chart(servicesChartEl, {
        type: 'doughnut',
        data: {
          labels: servicesChartData.labels || [],
          datasets: [{
            data: servicesChartData.data || [],
            backgroundColor: [
              'rgba(25, 135, 84, 0.8)',
              'rgba(13, 110, 253, 0.8)',
              'rgba(255, 193, 7, 0.8)',
              'rgba(108, 117, 125, 0.8)'
            ],
            borderColor: '#ffffff',
            borderWidth: 1,
            hoverOffset: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '70%',
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                padding: 15,
                usePointStyle: true,
                pointStyle: 'circle',
                font: {
                  size: 11
                }
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.raw || 0;
                  const total = context.dataset.data.reduce((sum, val) => sum + val, 0);
                  const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                  return `${label}: €${value.toLocaleString('de-DE')} (${percentage}%)`;
                }
              }
            }
          }
        }
      });
    }

    // Aktualisierungszeit starten
    startUpdateTimer();
  }

  // Zeigt einen Timer für die letzte Aktualisierung
  function startUpdateTimer() {
    const lastUpdateElement = document.getElementById('lastUpdateTime');
    if (!lastUpdateElement) return;

    let minutes = 0;
    setInterval(() => {
      lastUpdateElement.textContent = minutes++;
    }, 60000); // jede Minute aktualisieren
  }

  // Document Ready Handler
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize charts
    initDashboardCharts();
    
    // Set up auto-refresh counter
    const dashboardRefreshTime = document.getElementById('dashboardRefreshTime');
    if (dashboardRefreshTime) {
      let seconds = 300; // 5 Minuten
      const updateRefreshCounter = () => {
        seconds -= 1;
        if (seconds <= 0) {
          seconds = 300;
          // Hier würde fetchDashboardData() aufgerufen, aber wir haben das noch nicht implementiert
        }
        
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = seconds % 60;
        dashboardRefreshTime.textContent = `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
      };
      
      setInterval(updateRefreshCounter, 1000);
    }

    // Chart-Download-Funktionalität
    const downloadChartBtn = document.getElementById('downloadChartBtn');
    if (downloadChartBtn) {
      downloadChartBtn.addEventListener('click', function(e) {
        e.preventDefault();
        const revenueChart = document.getElementById('revenueChart');
        if (!revenueChart) return;
        
        // Bild erstellen
        const link = document.createElement('a');
        link.download = 'umsatzentwicklung.png';
        link.href = revenueChart.toDataURL('image/png');
        link.click();
      });
    }
    
    // Einrichtung der anderen Chart-Aktionen
    const refreshChartBtn = document.getElementById('refreshChartBtn');
    if (refreshChartBtn) {
      refreshChartBtn.addEventListener('click', function(e) {
        e.preventDefault();
        // Hier würde fetchDashboardData() aufgerufen
        alert('Daten werden aktualisiert...');
      });
    }
  });
</script>