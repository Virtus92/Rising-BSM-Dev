<%- include('../../partials/admin-header') %>

<div class="dashboard-wrapper">

    <!-- Dashboard Content -->
    <div class="dashboard-content p-3 p-md-4">
      <!-- Breadcrumb -->
      <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="/dashboard">Dashboard</a></li>
          <li class="breadcrumb-item"><a href="/dashboard/requests">Anfragen</a></li>
          <li class="breadcrumb-item active" aria-current="page">Anfrage #<%= request.id %></li>
        </ol>
      </nav>

      <% if (messages.success && messages.success.length > 0) { %>
        <div class="alert alert-success alert-dismissible fade show" role="alert">
          <i class="fas fa-check-circle me-2"></i><%= messages.success %>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      <% } %>
      
      <% if (messages.error && messages.error.length > 0) { %>
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
          <i class="fas fa-exclamation-circle me-2"></i><%= messages.error %>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      <% } %>

      <!-- Anfrage Details Card -->
      <div class="row g-4">
        <div class="col-lg-8">
          <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
              <h2 class="h5 mb-0">Anfrage Details</h2>
              <span class="badge bg-<%= request.statusClass %><%= request.status === 'Neu' ? ' text-dark' : '' %>">
                <%= request.status %>
              </span>
            </div>
            <div class="card-body">
              <div class="row mb-4">
                <div class="col-md-6">
                  <h3 class="h6 text-muted mb-2">Name</h3>
                  <p class="mb-0 fw-semibold"><%= request.name %></p>
                </div>
                <div class="col-md-6">
                  <h3 class="h6 text-muted mb-2">Datum</h3>
                  <p class="mb-0"><%= request.formattedDate %></p>
                </div>
              </div>
              
              <div class="row mb-4">
                <div class="col-md-6">
                  <h3 class="h6 text-muted mb-2">E-Mail</h3>
                  <p class="mb-0"><a href="mailto:<%= request.email %>" class="text-decoration-none"><%= request.email %></a></p>
                </div>
                <div class="col-md-6">
                  <h3 class="h6 text-muted mb-2">Telefon</h3>
                  <p class="mb-0"><%= request.phone %></p>
                </div>
              </div>
              
              <div class="row mb-4">
                <div class="col-12">
                  <h3 class="h6 text-muted mb-2">Gew체nschte Leistung</h3>
                  <p class="mb-0"><%= request.serviceLabel %></p>
                </div>
              </div>
              
              <div class="row">
                <div class="col-12">
                  <h3 class="h6 text-muted mb-2">Nachricht</h3>
                  <div class="p-3 bg-light rounded">
                    <%= request.message %>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Notizen -->
          <div class="card border-0 shadow-sm">
            <div class="card-header bg-white">
              <h2 class="h5 mb-0">Notizen</h2>
            </div>
            <div class="card-body">
              <% if (notes.length === 0) { %>
                <p class="text-muted">Keine Notizen vorhanden.</p>
              <% } else { %>
                <div class="timeline">
                  <% notes.forEach(function(notiz) { %>
                    <div class="timeline-item">
                      <div class="timeline-marker bg-success"></div>
                      <div class="timeline-content">
                        <div class="d-flex justify-content-between mb-2">
                          <span class="fw-semibold"><%= notiz.benutzer %></span>
                          <small class="text-muted"><%= notiz.formattedDate %></small>
                        </div>
                        <p class="mb-0"><%= notiz.text %></p>
                      </div>
                    </div>
                  <% }); %>
                </div>
              <% } %>
              
              <!-- Neue Notiz Form -->
              <form action="/dashboard/requests/<%= request.id %>/add-note" method="POST" class="mt-4">
                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                <input type="hidden" name="id" value="<%= request.id %>">
                
                <div class="mb-3">
                  <label for="noteText" class="form-label">Neue Notiz</label>
                  <textarea class="form-control" id="noteText" name="note" rows="3" required></textarea>
                </div>
                
                <button type="submit" class="btn btn-success">
                  <i class="fas fa-plus me-2"></i>Notiz hinzuf체gen
                </button>
              </form>
            </div>
          </div>
        </div>
        
        <div class="col-lg-4">
          <!-- Aktionen Card -->
          <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white">
              <h2 class="h5 mb-0">Aktionen</h2>
            </div>
            <div class="card-body">
              <button class="btn btn-primary w-100 mb-3" data-bs-toggle="modal" data-bs-target="#statusModal" data-id="<%= request.id %>" data-status="<%= request.status %>">
                <i class="fas fa-edit me-2"></i>Status 채ndern
              </button>
              
              <a href="/dashboard/customers/neu?name=<%= encodeURIComponent(request.name) %>&email=<%= encodeURIComponent(request.email) %>&phone=<%= encodeURIComponent(request.phone) %>" class="btn btn-success w-100 mb-3">
                <i class="fas fa-user-plus me-2"></i>Als Kunde anlegen
              </a>
              
              <a href="/dashboard/appointments/neu?kunde_name=<%= encodeURIComponent(request.name) %>" class="btn btn-info w-100 mb-3 text-white">
                <i class="fas fa-calendar-plus me-2"></i>Termin vereinbaren
              </a>
              
              <a href="mailto:<%= request.email %>" class="btn btn-outline-secondary w-100">
                <i class="fas fa-reply me-2"></i>E-Mail antworten
              </a>
            </div>
          </div>
          
          <!-- Kontakt Info Card -->
          <div class="card border-0 shadow-sm">
            <div class="card-header bg-white">
              <h2 class="h5 mb-0">Kontaktinformationen</h2>
            </div>
            <div class="list-group list-group-flush">
              <div class="list-group-item">
                <div class="d-flex align-items-center">
                  <div class="flex-shrink-0 me-3">
                    <div class="bg-success bg-opacity-10 p-2 rounded-circle">
                      <i class="fas fa-envelope text-success"></i>
                    </div>
                  </div>
                  <div>
                    <h6 class="mb-0">E-Mail</h6>
                    <a href="mailto:<%= request.email %>" class="text-decoration-none"><%= request.email %></a>
                  </div>
                </div>
              </div>
              
              <div class="list-group-item">
                <div class="d-flex align-items-center">
                  <div class="flex-shrink-0 me-3">
                    <div class="bg-success bg-opacity-10 p-2 rounded-circle">
                      <i class="fas fa-phone text-success"></i>
                    </div>
                  </div>
                  <div>
                    <h6 class="mb-0">Telefon</h6>
                    <% if (request.phone !== 'Nicht angegeben') { %>
                      <a href="tel:<%= request.phone %>" class="text-decoration-none"><%= request.phone %></a>
                    <% } else { %>
                      <span class="text-muted"><%= request.phone %></span>
                    <% } %>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>

<!-- Status Modal -->
<div class="modal fade" id="statusModal" tabindex="-1" aria-labelledby="statusModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="statusModalLabel">Status 채ndern</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="statusForm" action="/dashboard/requests/update-status" method="POST">
          <input type="hidden" name="_csrf" value="<%= csrfToken %>">
          <input type="hidden" name="id" value="<%= request.id %>">
          
          <div class="mb-3">
            <label for="status" class="form-label">Status</label>
            <select class="form-select" id="status" name="status" required>
              <option value="neu" <%= request.status === 'Neu' ? 'selected' : '' %>>Neu</option>
              <option value="in_bearbeitung" <%= request.status === 'In Bearbeitung' ? 'selected' : '' %>>In Bearbeitung</option>
              <option value="beantwortet" <%= request.status === 'Beantwortet' ? 'selected' : '' %>>Beantwortet</option>
              <option value="geschlossen" <%= request.status === 'Geschlossen' ? 'selected' : '' %>>Geschlossen</option>
            </select>
          </div>
          
          <div class="mb-3">
            <label for="note" class="form-label">Notiz (optional)</label>
            <textarea class="form-control" id="note" name="note" rows="3"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Abbrechen</button>
        <button type="submit" form="statusForm" class="btn btn-success">Speichern</button>
      </div>
    </div>
  </div>
</div>

<style>
  /* Timeline Styles */
  .timeline {
    position: relative;
    padding-left: 1.5rem;
  }
  
  .timeline:before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    height: 100%;
    width: 2px;
    background-color: #e9ecef;
  }
  
  .timeline-item {
    position: relative;
    padding-bottom: 1.5rem;
  }
  
  .timeline-marker {
    position: absolute;
    left: -1.5rem;
    top: 0;
    width: 1rem;
    height: 1rem;
    border-radius: 50%;
  }
  
  .timeline-content {
    background-color: #f8f9fa;
    padding: 1rem;
    border-radius: 0.25rem;
  }
</style>

<%- include('../../partials/admin-footer-simple') %>