<%- include('../../partials/admin-header') %>

<div class="dashboard-wrapper">
    <!-- Dashboard Content -->
    <div class="dashboard-content p-3 p-md-4">
      <!-- Filter & Aktionen -->
      <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 gap-3">
        <div>
          <h2 class="h4 mb-1">Kundenverwaltung</h2>
          <p class="text-muted mb-md-0">Alle Kunden von Rising BSM</p>
        </div>
        <div class="d-flex flex-wrap gap-2">
          <!-- Search Form -->
          <form action="/dashboard/customers" method="GET" id="searchForm">
            <div class="input-group">
              <span class="input-group-text bg-white">
                <i class="fas fa-search text-muted"></i>
              </span>
              <input type="text" class="form-control" id="searchInput" name="search" value="<%= filters && filters.search || '' %>" placeholder="Name, Email oder Firma suchen..." autocomplete="off">
              <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">Filter</button>
              <ul class="dropdown-menu dropdown-menu-end">
                <li><h6 class="dropdown-header">Status</h6></li>
                <li><a class="dropdown-item <%= filters && filters.status === 'aktiv' ? 'active' : '' %>" href="?status=aktiv<%= filters && filters.search ? '&search='+filters.search : '' %>">Nur aktive Kunden</a></li>
                <li><a class="dropdown-item <%= filters && filters.status === 'inaktiv' ? 'active' : '' %>" href="?status=inaktiv<%= filters && filters.search ? '&search='+filters.search : '' %>">Nur inaktive Kunden</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><h6 class="dropdown-header">Kundentyp</h6></li>
                <li><a class="dropdown-item <%= filters.type === 'privat' ? 'active' : '' %>" href="?type=privat<%= filters.search ? '&search='+filters.search : '' %>">Privatkunden</a></li>
                <li><a class="dropdown-item <%= filters.type === 'geschaeft' ? 'active' : '' %>" href="?type=geschaeft<%= filters.search ? '&search='+filters.search : '' %>">Geschäftskunden</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="/dashboard/customers">Filter zurücksetzen</a></li>
              </ul>
            </div>
          </form>
          <a href="/dashboard/customers/neu" class="btn btn-success">
            <i class="fas fa-plus me-2"></i>Neuer Kunde
          </a>
          <div class="dropdown">
            <button class="btn btn-outline-primary dropdown-toggle" type="button" id="exportDropdown" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="fas fa-download me-2"></i>Export
            </button>
            <ul class="dropdown-menu" aria-labelledby="exportDropdown">
              <li><a class="dropdown-item" href="/dashboard/customers/export?format=csv">CSV-Export</a></li>
              <li><a class="dropdown-item" href="/dashboard/customers/export?format=excel">Excel-Export</a></li>
              <li><a class="dropdown-item" href="/dashboard/customers/export?format=pdf">PDF-Export</a></li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Kundenstatistiken -->
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-white">
          <h5 class="card-title mb-0">Kundenstatistiken</h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-sm-6 col-md-3">
              <div class="statistic-card bg-primary text-white rounded p-3 d-flex align-items-center justify-content-between">
                <div>
                  <div class="h5 mb-0"><%= stats.total %></div>
                  <p class="mb-0 small">Kunden insgesamt</p>
                </div>
                <i class="fas fa-users fa-2x opacity-50"></i>
              </div>
            </div>
            <div class="col-sm-6 col-md-3">
              <div class="statistic-card bg-info text-white rounded p-3 d-flex align-items-center justify-content-between">
                <div>
                  <div class="h5 mb-0"><%= stats.privat %></div>
                  <p class="mb-0 small">Privatkunden</p>
                </div>
                <i class="fas fa-user fa-2x opacity-50"></i>
              </div>
            </div>
            <div class="col-sm-6 col-md-3">
              <div class="statistic-card bg-success text-white rounded p-3 d-flex align-items-center justify-content-between">
                <div>
                  <div class="h5 mb-0"><%= stats.geschaeft %></div>
                  <p class="mb-0 small">Geschäftskunden</p>
                </div>
                <i class="fas fa-building fa-2x opacity-50"></i>
              </div>
            </div>
            <div class="col-sm-6 col-md-3">
              <div class="statistic-card bg-warning text-white rounded p-3 d-flex align-items-center justify-content-between">
                <div>
                  <div class="h5 mb-0"><%= stats.aktiv %></div>
                  <p class="mb-0 small">Aktive Kunden</p>
                </div>
                <i class="fas fa-check-circle fa-2x opacity-50"></i>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Ansichtsoptionen -->
      <ul class="nav nav-tabs mb-4" id="viewTab" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="list-tab" data-bs-toggle="tab" data-bs-target="#list-view" type="button" role="tab" aria-controls="list-view" aria-selected="true">
            <i class="fas fa-list me-2"></i>Liste
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="grid-tab" data-bs-toggle="tab" data-bs-target="#grid-view" type="button" role="tab" aria-controls="grid-view" aria-selected="false">
            <i class="fas fa-th-large me-2"></i>Karten
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="stats-tab" data-bs-toggle="tab" data-bs-target="#stats-view" type="button" role="tab" aria-controls="stats-view" aria-selected="false">
            <i class="fas fa-chart-pie me-2"></i>Statistik
          </button>
        </li>
      </ul>

      <!-- Tab-Inhalte -->
      <div class="tab-content">
        <!-- Listen-Ansicht -->
        <div class="tab-pane fade show active" id="list-view" role="tabpanel" aria-labelledby="list-tab">
          <div class="card border-0 shadow-sm">
            <div class="card-body p-0">
              <!-- Desktop Table View - Hidden on Small Screens -->
              <div class="d-none d-md-block table-responsive">
                <table class="table table-hover customer-table mb-0" id="customerTable">
                  <thead class="table-light">
                    <tr>
                      <th scope="col">Name</th>
                      <th scope="col">Firma</th>
                      <th scope="col">Kontakt</th>
                      <th scope="col">Adresse</th>
                      <th scope="col">Status</th>
                      <th scope="col">Aktionen</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% if (typeof customers !== 'undefined' && customers.length > 0) { %>
                      <% customers.forEach(function(customer) { %>
                        <tr>
                          <td>
                            <div class="d-flex align-items-center">
                              <div class="avatar-wrapper bg-light rounded-circle me-2 text-center" style="width: 32px; height: 32px; line-height: 32px;">
                                <span><%= customer.name.charAt(0) %></span>
                              </div>
                              <div>
                                <a href="/dashboard/customers/<%= customer.id %>" class="text-decoration-none text-dark fw-medium">
                                  <%= customer.name %>
                                </a>
                              </div>
                            </div>
                          </td>
                          <td><%= customer.firma || '–' %></td>
                          <td>
                            <% if (customer.email) { %>
                              <div><a href="mailto:<%= customer.email %>" class="text-decoration-none text-primary"><i class="fas fa-envelope me-1"></i><%= customer.email %></a></div>
                            <% } %>
                            <% if (customer.telefon) { %>
                              <div><a href="tel:<%= customer.telefon %>" class="text-decoration-none text-success"><i class="fas fa-phone me-1"></i><%= customer.telefon %></a></div>
                            <% } %>
                          </td>
                          <td>
                            <% if (customer.adresse) { %>
                              <%= customer.adresse %><br>
                              <%= customer.plz %> <%= customer.ort %>
                            <% } else { %>
                              <span class="text-muted">–</span>
                            <% } %>
                          </td>
                          <td>
                            <span class="badge bg-<%= customer.status === 'aktiv' ? 'success' : 'secondary' %>">
                              <%= customer.status === 'aktiv' ? 'Aktiv' : 'Inaktiv' %>
                            </span>
                          </td>
                          <td>
                            <div class="btn-group btn-group-sm">
                              <a href="/dashboard/customers/<%= customer.id %>" class="btn btn-outline-secondary">
                                <i class="fas fa-eye"></i>
                              </a>
                              <a href="/dashboard/customers/<%= customer.id %>/edit" class="btn btn-outline-primary">
                                <i class="fas fa-edit"></i>
                              </a>
                              <button type="button" class="btn btn-outline-secondary dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">
                                <span class="visually-hidden">Dropdown</span>
                              </button>
                              <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="/dashboard/appointments/neu?kunde=<%= customer.id %>"><i class="fas fa-calendar-plus me-2"></i>Termin erstellen</a></li>
                                <li><a class="dropdown-item" href="/dashboard/projects/neu?kunde_id=<%= customer.id %>"><i class="fas fa-project-diagram me-2"></i>Projekt erstellen</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#changeStatusModal" data-id="<%= customer.id %>" data-name="<%= customer.name %>" data-status="<%= customer.status %>"><i class="fas fa-toggle-on me-2"></i>Status ändern</a></li>
                                <li><a class="dropdown-item text-danger" href="#" data-bs-toggle="modal" data-bs-target="#deleteCustomerModal" data-id="<%= customer.id %>" data-name="<%= customer.name %>"><i class="fas fa-trash-alt me-2"></i>Löschen</a></li>
                              </ul>
                            </div>
                          </td>
                        </tr>
                      <% }); %>
                    <% } else { %>
                      <tr>
                        <td colspan="6" class="text-center py-4">
                          <p class="text-muted mb-0">Keine Kunden gefunden</p>
                        </td>
                      </tr>
                    <% } %>
                  </tbody>
                </table>
              </div>

              <!-- Mobile Card View - Shown Only on Small Screens -->
              <div class="d-md-none">
                <% if (typeof customers !== 'undefined' && customers.length > 0) { %>
                  <div class="list-group list-group-flush">
                    <% customers.forEach(function(customer) { %>
                      <div class="list-group-item p-3">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                          <div class="d-flex align-items-center">
                            <div class="avatar-wrapper bg-light rounded-circle me-2 text-center" style="min-width: 32px; height: 32px; line-height: 32px;">
                              <span><%= customer.name.charAt(0) %></span>
                            </div>
                            <div>
                              <a href="/dashboard/customers/<%= customer.id %>" class="text-decoration-none text-dark fw-medium">
                                <%= customer.name %>
                              </a>
                              <div class="small text-muted"><%= customer.firma || 'Privatkunde' %></div>
                            </div>
                          </div>
                          <span class="badge bg-<%= customer.status === 'aktiv' ? 'success' : 'secondary' %>">
                            <%= customer.status === 'aktiv' ? 'Aktiv' : 'Inaktiv' %>
                          </span>
                        </div>

                        <div class="mb-2">
                          <% if (customer.email) { %>
                            <div><a href="mailto:<%= customer.email %>" class="text-decoration-none text-primary small"><i class="fas fa-envelope me-1"></i><%= customer.email %></a></div>
                          <% } %>
                          <% if (customer.telefon) { %>
                            <div><a href="tel:<%= customer.telefon %>" class="text-decoration-none text-success small"><i class="fas fa-phone me-1"></i><%= customer.telefon %></a></div>
                          <% } %>
                        </div>

                        <div class="d-flex justify-content-between align-items-center mt-3">
                          <div class="btn-group btn-group-sm">
                            <a href="/dashboard/customers/<%= customer.id %>" class="btn btn-outline-secondary">
                              <i class="fas fa-eye"></i>
                            </a>
                            <a href="/dashboard/customers/<%= customer.id %>/edit" class="btn btn-outline-primary">
                              <i class="fas fa-edit"></i>
                            </a>
                          </div>
                          <div class="dropdown">
                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="customerActionsDropdown<%= customer.id %>" data-bs-toggle="dropdown" aria-expanded="false">
                              Mehr
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="customerActionsDropdown<%= customer.id %>">
                              <li><a class="dropdown-item" href="/dashboard/appointments/neu?kunde=<%= customer.id %>"><i class="fas fa-calendar-plus me-2"></i>Termin erstellen</a></li>
                              <li><a class="dropdown-item" href="/dashboard/projects/neu?kunde_id=<%= customer.id %>"><i class="fas fa-project-diagram me-2"></i>Projekt erstellen</a></li>
                              <li><hr class="dropdown-divider"></li>
                              <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#changeStatusModal" data-id="<%= customer.id %>" data-name="<%= customer.name %>" data-status="<%= customer.status %>"><i class="fas fa-toggle-on me-2"></i>Status ändern</a></li>
                              <li><a class="dropdown-item text-danger" href="#" data-bs-toggle="modal" data-bs-target="#deleteCustomerModal" data-id="<%= customer.id %>" data-name="<%= customer.name %>"><i class="fas fa-trash-alt me-2"></i>Löschen</a></li>
                            </ul>
                          </div>
                        </div>
                      </div>
                    <% }); %>
                  </div>
                <% } else { %>
                  <div class="text-center py-4">
                    <p class="text-muted mb-0">Keine Kunden gefunden</p>
                  </div>
                <% } %>
              </div>
            </div>
          </div>
        </div>

        <!-- Karten-Ansicht -->
        <div class="tab-pane fade" id="grid-view" role="tabpanel" aria-labelledby="grid-tab">
          <div class="row g-3">
            <% if (typeof customers !== 'undefined' && customers.length > 0) { %>
              <% customers.forEach(function(customer) { %>
                <div class="col-md-6 col-lg-4 col-xl-3">
                  <div class="card h-100 border-0 shadow-sm">
                    <div class="card-body">
                      <div class="d-flex align-items-center mb-3">
                        <div class="avatar-wrapper bg-light rounded-circle me-3 text-center" style="width: 48px; height: 48px; line-height: 48px;">
                          <span class="h5 mb-0"><%= customer.name.charAt(0) %></span>
                        </div>
                        <div>
                          <h5 class="card-title mb-0"><%= customer.name %></h5>
                          <p class="card-text text-muted small"><%= customer.firma || 'Privatkunde' %></p>
                        </div>
                        <div class="ms-auto">
                          <span class="badge bg-<%= customer.status === 'aktiv' ? 'success' : 'secondary' %>">
                            <%= customer.status === 'aktiv' ? 'Aktiv' : 'Inaktiv' %>
                          </span>
                        </div>
                      </div>
                      
                      <p class="card-text mb-2">
                        <i class="fas fa-envelope text-muted me-2"></i>
                        <a href="mailto:<%= customer.email %>" class="text-decoration-none"><%= customer.email %></a>
                      </p>
                      
                      <% if (customer.telefon) { %>
                        <p class="card-text mb-2">
                          <i class="fas fa-phone text-muted me-2"></i>
                          <a href="tel:<%= customer.telefon %>" class="text-decoration-none"><%= customer.telefon %></a>
                        </p>
                      <% } %>
                      
                      <% if (customer.adresse) { %>
                        <p class="card-text mb-2">
                          <i class="fas fa-map-marker-alt text-muted me-2"></i>
                          <%= customer.adresse %>, <%= customer.plz %> <%= customer.ort %>
                        </p>
                      <% } %>
                      
                      <div class="mt-3 d-flex justify-content-between">
                        <a href="/dashboard/customers/<%= customer.id %>" class="btn btn-sm btn-outline-primary">Details</a>
                        <div class="btn-group btn-group-sm">
                          <a href="/dashboard/appointments/neu?kunde=<%= customer.id %>" class="btn btn-outline-success">
                            <i class="fas fa-calendar-plus"></i>
                          </a>
                          <a href="/dashboard/projects/neu?kunde_id=<%= customer.id %>" class="btn btn-outline-info">
                            <i class="fas fa-project-diagram"></i>
                          </a>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              <% }); %>
            <% } else { %>
              <div class="col-12">
                <div class="alert alert-info">
                  <i class="fas fa-info-circle me-2"></i> Keine Kunden gefunden.
                </div>
              </div>
            <% } %>
          </div>
        </div>

        <!-- Statistik-Ansicht -->
        <div class="tab-pane fade" id="stats-view" role="tabpanel" aria-labelledby="stats-tab">
          <div class="row g-3">
            <div class="col-md-6">
              <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                  <h5 class="card-title mb-0">Kundentypen</h5>
                </div>
                <div class="card-body">
                  <canvas id="customerTypeChart" height="250"></canvas>
                </div>
              </div>
            </div>
            
            <div class="col-md-6">
              <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                  <h5 class="card-title mb-0">Kundenstatus</h5>
                </div>
                <div class="card-body">
                  <canvas id="customerStatusChart" height="250"></canvas>
                </div>
              </div>
            </div>
            
            <div class="col-md-12">
              <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                  <h5 class="card-title mb-0">Kundenentwicklung</h5>
                </div>
                <div class="card-body">
                  <canvas id="customerGrowthChart" height="300"></canvas>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Pagination -->
      <% if (pagination.total > 1) { %>
        <nav aria-label="Kunden Pagination" class="mt-4">
          <ul class="pagination justify-content-center">
            <% if (pagination.current > 1) { %>
              <li class="page-item">
                <a class="page-link" href="?page=<%= pagination.current-1 %><%= filters && filters.status ? '&status='+filters.status : '' %><%= filters && filters.type ? '&type='+filters.type : '' %><%= filters && filters.search ? '&search='+filters.search : '' %>">Zurück</a>
              </li>
            <% } else { %>
              <li class="page-item disabled">
                <span class="page-link">Zurück</span>
              </li>
            <% } %>
            
            <% for(let i = Math.max(1, pagination.current-2); i <= Math.min(pagination.total, pagination.current+2); i++) { %>
              <li class="page-item <%= pagination.current == i ? 'active' : '' %>">
                <a class="page-link" href="?page=<%= i %><%= filters && filters.status ? '&status='+filters.status : '' %><%= filters && filters.type ? '&type='+filters.type : '' %><%= filters && filters.search ? '&search='+filters.search : '' %>"><%= i %></a>
              </li>
            <% } %>
            
            <% if (pagination.current < pagination.total) { %>
              <li class="page-item">
                <a class="page-link" href="?page=<%= pagination.current+1 %><%= filters.status ? '&status='+filters.status : '' %><%= filters.type ? '&type='+filters.type : '' %><%= filters.search ? '&search='+filters.search : '' %>">Weiter</a>
              </li>
            <% } else { %>
              <li class="page-item disabled">
                <span class="page-link">Weiter</span>
              </li>
            <% } %>
          </ul>
        </nav>
      <% } %>
    </div>
  </main>
</div>

<!-- Löschen-Bestätigung Modal -->
<div class="modal fade" id="deleteCustomerModal" tabindex="-1" aria-labelledby="deleteCustomerModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteCustomerModalLabel">Kunde löschen</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Sind Sie sicher, dass Sie den Kunden <strong id="customerNameToDelete"></strong> löschen möchten?</p>
        <p class="text-danger">Diese Aktion kann nicht rückgängig gemacht werden.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Abbrechen</button>
        <form id="deleteCustomerForm" action="/dashboard/customers/delete" method="POST">
          <input type="hidden" name="_csrf" value="<%= csrfToken %>">
          <input type="hidden" id="customerIdToDelete" name="id">
          <button type="submit" class="btn btn-danger">Löschen</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Status-Änderung Modal -->
<div class="modal fade" id="changeStatusModal" tabindex="-1" aria-labelledby="changeStatusModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="changeStatusModalLabel">Kundenstatus ändern</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Möchten Sie den Status des Kunden <strong id="customerNameToChange"></strong> ändern?</p>
        <form id="changeStatusForm" action="/dashboard/customers/update-status" method="POST">
          <input type="hidden" name="_csrf" value="<%= csrfToken %>">
          <input type="hidden" id="customerIdToChange" name="id">
          
          <div class="mb-3">
            <label for="statusSelect" class="form-label">Status</label>
            <select class="form-select" id="statusSelect" name="status">
              <option value="aktiv">Aktiv</option>
              <option value="inaktiv">Inaktiv</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Abbrechen</button>
        <button type="submit" form="changeStatusForm" class="btn btn-primary">Speichern</button>
      </div>
    </div>
  </div>
</div>

<%- include('../../partials/admin-footer-simple') %>

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Alternative zu DataTables für bessere mobile Unterstützung
    const customerTable = document.getElementById('customerTable');
    if (customerTable) {
      // Hier könnten wir eine einfachere Tabellenfunktionalität implementieren
      // ohne DataTables für bessere Mobilunterstützung
      
      // Suchfunktion
      const searchInput = document.getElementById('searchInput');
      if (searchInput) {
        searchInput.addEventListener('keyup', function() {
          const searchTerm = this.value.toLowerCase();
          const rows = customerTable.querySelectorAll('tbody tr');
          
          rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(searchTerm) ? '' : 'none';
          });
        });
      }
    }
    
    // Suchfeld-Funktionalität für Serversuche
    const searchForm = document.getElementById('searchForm');
    if (searchForm) {
      searchForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const searchValue = document.getElementById('searchInput').value.trim();
        let url = `/dashboard/customers?search=${encodeURIComponent(searchValue)}`;
        if (filters.status) {
          url += `&status=${filters.status}`;
        }
        if (filters.type) {
          url += `&type=${filters.type}`;
        }
        window.location.href = url;
      });

      document.getElementById('searchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          document.getElementById('searchForm').dispatchEvent(new Event('submit'));
        }
      });
    }
    
    // Lösch-Modal Funktionalität
    const deleteCustomerModal = document.getElementById('deleteCustomerModal');
    if (deleteCustomerModal) {
      deleteCustomerModal.addEventListener('show.bs.modal', function(event) {
        const button = event.relatedTarget;
        const customerId = button.getAttribute('data-id');
        const customerName = button.getAttribute('data-name');
        
        document.getElementById('customerIdToDelete').value = customerId;
        document.getElementById('customerNameToDelete').textContent = customerName;
      });
    }
    
    // Status-Änderung Modal Funktionalität
    const changeStatusModal = document.getElementById('changeStatusModal');
    if (changeStatusModal) {
      changeStatusModal.addEventListener('show.bs.modal', function(event) {
        const button = event.relatedTarget;
        const customerId = button.getAttribute('data-id');
        const customerName = button.getAttribute('data-name');
        const currentStatus = button.getAttribute('data-status');
        
        document.getElementById('customerIdToChange').value = customerId;
        document.getElementById('customerNameToChange').textContent = customerName;
        document.getElementById('statusSelect').value = currentStatus;
      });
    }
  });

  // Chart-Konfigurationen und -Initialisierung
  const customerTypeChartCanvas = document.getElementById('customerTypeChart').getContext('2d');
  const customerStatusChartCanvas = document.getElementById('customerStatusChart').getContext('2d');
  const customerGrowthChartCanvas = document.getElementById('customerGrowthChart').getContext('2d');
  
  // Kundentyp Chart
  new Chart(customerTypeChartCanvas, {
    type: 'pie',
    data: {
      labels: ['Privatkunden', 'Geschäftskunden'],
      datasets: [{
        label: 'Kundentypen',
        data: [<%= stats.privat %>, <%= stats.geschaeft %>],
        backgroundColor: [
          'rgba(54, 162, 235, 0.8)',
          'rgba(255, 99, 132, 0.8)'
        ],
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom',
        },
        title: {
          display: false,
          text: 'Kundentypen'
        }
      }
    }
  });

  // Kundenstatus Chart
  new Chart(customerStatusChartCanvas, {
    type: 'pie',
    data: {
      labels: ['Aktiv', 'Inaktiv'],
      datasets: [{
        label: 'Kundenstatus',
        data: [<%= stats.aktiv %>, <%= stats.total - stats.aktiv %>],
        backgroundColor: [
          'rgba(75, 192, 192, 0.8)',
          'rgba(201, 203, 207, 0.8)'
        ],
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom',
        },
        title: {
          display: false,
          text: 'Kundenstatus'
        }
      }
    }
  });

  // Kundenwachstums Chart
  new Chart(customerGrowthChartCanvas, {
    type: 'line',
    data: {
      labels: <%- JSON.stringify(customerGrowthData.map(item => item.month)) %>,
      datasets: [{
        label: 'Neue Kunden',
        data: <%- JSON.stringify(customerGrowthData.map(item => item.customer_count)) %>,
        fill: false,
        borderColor: 'rgba(255, 205, 86, 0.8)',
        tension: 0.1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true
        }
      },
      plugins: {
        legend: {
          position: 'bottom',
        },
        title: {
          display: false,
          text: 'Kundenwachstum'
        }
      }
    }
  });
</script>