<%- include('../../partials/admin-header') %>

<div class="container-fluid py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0 text-gray-800">Blogpost bearbeiten</h1>
    <a href="/dashboard/blog/<%= post.id %>" class="btn btn-outline-secondary">
      <i class="fas fa-arrow-left me-1"></i> Zurück
    </a>
  </div>

  <% if (messages.success && messages.success.length > 0) { %>
  <div class="alert alert-success alert-dismissible fade show" role="alert">
    <%= messages.success %>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
  <% } %>
  
  <% if (messages.error && messages.error.length > 0) { %>
  <div class="alert alert-danger alert-dismissible fade show" role="alert">
    <%= messages.error %>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
  <% } %>

  <div class="card shadow-sm mb-4">
    <div class="card-header">
      <h5 class="mb-0">Blogpost bearbeiten</h5>
    </div>
    <div class="card-body">
      <form action="/dashboard/blog/<%= post.id %>/edit" method="POST">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
        
        <div class="row mb-3">
          <div class="col-md-8">
            <label for="title" class="form-label">Titel *</label>
            <input type="text" class="form-control" id="title" name="title" value="<%= post.title %>" required>
          </div>
          <div class="col-md-4">
            <label for="status" class="form-label">Status *</label>
            <select class="form-select" id="status" name="status" required>
              <option value="draft" <%= post.status === 'draft' ? 'selected' : '' %>>Entwurf</option>
              <option value="review" <%= post.status === 'review' ? 'selected' : '' %>>In Prüfung</option>
              <option value="published" <%= post.status === 'published' ? 'selected' : '' %>>Veröffentlicht</option>
            </select>
          </div>
        </div>
        
        <div class="row mb-3">
          <div class="col-12">
            <label for="excerpt" class="form-label">Auszug / Kurzbeschreibung</label>
            <textarea class="form-control" id="excerpt" name="excerpt" rows="3"><%= post.excerpt %></textarea>
            <div class="form-text">Ein kurzer Auszug oder eine Zusammenfassung des Blogposts (maximal 255 Zeichen).</div>
          </div>
        </div>
        
        <div class="row mb-3">
          <div class="col-12">
            <label for="content" class="form-label">Inhalt *</label>
            <textarea class="form-control" id="content" name="content" rows="20" required><%= post.content %></textarea>
          </div>
        </div>
        
        <div class="row mb-3">
          <div class="col-md-6">
            <label class="form-label">Kategorien</label>
            <div class="card">
              <div class="card-body" style="max-height: 200px; overflow-y: auto;">
                <% categories.forEach(function(category) { %>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" 
                      name="categories[]" 
                      value="<%= category.id %>" 
                      id="category<%= category.id %>"
                      <%= assignedCategories.includes(category.id) ? 'checked' : '' %>>
                    <label class="form-check-label" for="category<%= category.id %>">
                      <%= category.name %>
                    </label>
                  </div>
                <% }); %>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <label for="tags" class="form-label">Tags</label>
            <select class="form-select" id="tags" name="tags" multiple data-placeholder="Tags auswählen oder neue Tags eingeben...">
              <% if (assignedTags && assignedTags.length > 0) { %>
                <% assignedTags.forEach(function(tag) { %>
                  <option value="<%= tag.id %>" selected><%= tag.name %></option>
                <% }); %>
              <% } %>
              <% tags.forEach(function(tag) { %>
                <% const isAssigned = assignedTags.some(t => t.id === tag.id); %>
                <% if (!isAssigned) { %>
                  <option value="<%= tag.id %>"><%= tag.name %></option>
                <% } %>
              <% }); %>
            </select>
            <div class="form-text">Bestehende Tags auswählen oder neue Tags durch Komma getrennt eingeben.</div>
          </div>
        </div>
        
        <div class="row mb-3">
          <div class="col-12">
            <label for="featured_image" class="form-label">Titelbild URL</label>
            <input type="text" class="form-control" id="featured_image" name="featured_image" value="<%= post.featured_image %>">
            <div class="form-text">URL zu einem Bild, das als Titelbild für den Blogpost verwendet wird.</div>
          </div>
        </div>
        
        <hr class="my-4">
        
        <h5 class="mb-3">SEO-Einstellungen</h5>
        
        <div class="row mb-3">
          <div class="col-12">
            <label for="seo_title" class="form-label">SEO-Titel</label>
            <input type="text" class="form-control" id="seo_title" name="seo_title" value="<%= post.seo_title %>">
            <div class="form-text">Der Titel, der in Suchergebnissen angezeigt wird. Falls leer, wird der normale Titel verwendet.</div>
          </div>
        </div>
        
        <div class="row mb-3">
          <div class="col-12">
            <label for="seo_description" class="form-label">Meta-Beschreibung</label>
            <textarea class="form-control" id="seo_description" name="seo_description" rows="2"><%= post.seo_description %></textarea>
            <div class="form-text">Die Beschreibung, die in Suchergebnissen angezeigt wird. Falls leer, wird der Auszug verwendet.</div>
          </div>
        </div>
        
        <div class="row mb-3">
          <div class="col-12">
            <label for="seo_keywords" class="form-label">Keywords</label>
            <input type="text" class="form-control" id="seo_keywords" name="seo_keywords" value="<%= post.seo_keywords %>">
            <div class="form-text">Kommagetrennte Liste von Keywords für Suchmaschinen.</div>
          </div>
        </div>
        
        <div class="form-check mb-3">
          <input class="form-check-input" type="checkbox" id="update_slug" name="update_slug">
          <label class="form-check-label" for="update_slug">
            Slug aktualisieren
          </label>
          <div class="form-text">Wenn aktiviert, wird der Slug basierend auf dem neuen Titel aktualisiert. Dies kann bestehende Links ungültig machen!</div>
        </div>
        
        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
          <a href="/dashboard/blog/<%= post.id %>" class="btn btn-outline-secondary">Abbrechen</a>
          <button type="submit" class="btn btn-primary">Speichern</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize the rich text editor for the content field
    if (typeof ClassicEditor !== 'undefined') {
      ClassicEditor
        .create(document.querySelector('#content'), {
          toolbar: ['heading', '|', 'bold', 'italic', 'link', 'bulletedList', 'numberedList', 'blockQuote', 'insertTable', 'undo', 'redo']
        })
        .catch(error => {
          console.error('Error initializing CKEditor:', error);
        });
    }
    
    // Initialize select2 for tags if available
    if (typeof $ !== 'undefined' && $.fn.select2) {
      $('#tags').select2({
        tags: true,
        tokenSeparators: [',', ' '],
        placeholder: "Tags auswählen oder neue Tags eingeben..."
      });
    }

    // Initialize the rich text editor for the content field
    if (typeof ClassicEditor !== 'undefined') {
      ClassicEditor
        .create(document.querySelector('#content'), {
          toolbar: ['heading', '|', 'bold', 'italic', 'link', 'bulletedList', 'numberedList', 'blockQuote', 'insertTable', 'undo', 'redo']
        })
        .catch(error => {
          console.error('Error initializing CKEditor:', error);
        });
    }
  });
</script>

<%- include('../../partials/admin-footer-simple') %>