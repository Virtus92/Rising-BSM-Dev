<%- include('../../partials/admin-header') %>

<div class="container-fluid py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0 text-gray-800"><%= post.title %></h1>
    <div class="d-flex gap-2">
      <a href="/dashboard/blog/<%= post.id %>/edit" class="btn btn-primary">
        <i class="fas fa-edit me-1"></i> Bearbeiten
      </a>
      <div class="dropdown">
        <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="statusDropdown" data-bs-toggle="dropdown" aria-expanded="false">
          <i class="fas fa-cog me-1"></i> Status ändern
        </button>
        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="statusDropdown">
          <% if (post.status !== 'published') { %>
          <li>
            <form action="/dashboard/blog/<%= post.id %>/status" method="POST" class="status-form">
              <input type="hidden" name="_csrf" value="<%= csrfToken %>">
              <input type="hidden" name="status" value="published">
              <button type="submit" class="dropdown-item text-success">
                <i class="fas fa-check-circle me-2"></i> Veröffentlichen
              </button>
            </form>
          </li>
          <% } %>
          <% if (post.status !== 'draft') { %>
          <li>
            <form action="/dashboard/blog/<%= post.id %>/status" method="POST" class="status-form">
              <input type="hidden" name="_csrf" value="<%= csrfToken %>">
              <input type="hidden" name="status" value="draft">
              <button type="submit" class="dropdown-item text-secondary">
                <i class="fas fa-edit me-2"></i> Als Entwurf speichern
              </button>
            </form>
          </li>
          <% } %>
          <% if (post.status !== 'review') { %>
          <li>
            <form action="/dashboard/blog/<%= post.id %>/status" method="POST" class="status-form">
              <input type="hidden" name="_csrf" value="<%= csrfToken %>">
              <input type="hidden" name="status" value="review">
              <button type="submit" class="dropdown-item text-warning">
                <i class="fas fa-eye me-2"></i> Zur Prüfung einreichen
              </button>
            </form>
          </li>
          <% } %>
        </ul>
      </div>
    </div>
  </div>

  <% if (messages.success && messages.success.length > 0) { %>
  <div class="alert alert-success alert-dismissible fade show" role="alert">
    <%= messages.success %>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
  <% } %>
  
  <% if (messages.error && messages.error.length > 0) { %>
  <div class="alert alert-danger alert-dismissible fade show" role="alert">
    <%= messages.error %>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
  <% } %>

  <div class="row">
    <!-- Blog Content -->
    <div class="col-lg-8">
      <div class="card shadow-sm mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Blogpost Informationen</h5>
          <span class="badge bg-<%= post.statusClass %> py-2 px-3"><%= post.statusLabel %></span>
        </div>
        <div class="card-body">
          <div class="row mb-3">
            <div class="col-md-6">
              <h6 class="text-muted mb-2">Erstelldatum</h6>
              <p><%= post.createdAt %></p>
            </div>
            <div class="col-md-6">
              <h6 class="text-muted mb-2">Autor</h6>
              <p><%= post.author %></p>
            </div>
          </div>
          
          <div class="row mb-3">
            <div class="col-md-6">
              <h6 class="text-muted mb-2">Status</h6>
              <p><span class="badge bg-<%= post.statusClass %>"><%= post.statusLabel %></span></p>
            </div>
            <div class="col-md-6">
              <h6 class="text-muted mb-2">Veröffentlichungsdatum</h6>
              <p><%= post.publishedAt || 'Noch nicht veröffentlicht' %></p>
            </div>
          </div>
          
          <% if (post.featuredImage) { %>
          <div class="mb-3">
            <h6 class="text-muted mb-2">Titelbild</h6>
            <img src="<%= post.featuredImage %>" alt="<%= post.title %>" class="img-fluid rounded" style="max-height: 200px;">
          </div>
          <% } %>
          
          <div class="mb-3">
            <h6 class="text-muted mb-2">Auszug</h6>
            <p><%= post.excerpt || 'Kein Auszug vorhanden' %></p>
          </div>
          
          <div class="mb-3">
            <h6 class="text-muted mb-2">Kategorien</h6>
            <div>
              <% if (categories && categories.length > 0) { %>
                <% categories.forEach(function(category) { %>
                  <span class="badge bg-primary me-2 mb-2"><%= category.name %></span>
                <% }); %>
              <% } else { %>
                <p class="text-muted">Keine Kategorien zugewiesen</p>
              <% } %>
            </div>
          </div>
          
          <div class="mb-3">
            <h6 class="text-muted mb-2">Tags</h6>
            <div>
              <% if (tags && tags.length > 0) { %>
                <% tags.forEach(function(tag) { %>
                  <span class="badge bg-secondary me-2 mb-2"><%= tag.name %></span>
                <% }); %>
              <% } else { %>
                <p class="text-muted">Keine Tags zugewiesen</p>
              <% } %>
            </div>
          </div>
        </div>
      </div>
      
      <div class="card shadow-sm mb-4">
        <div class="card-header">
          <h5 class="mb-0">Content</h5>
        </div>
        <div class="card-body">
          <div class="content-preview mb-3 p-3 border rounded bg-light">
            <%- post.content %>
          </div>
        </div>
      </div>
      
      <div class="card shadow-sm mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">KI-Content-Verbesserung</h5>
        </div>
        <div class="card-body">
          <p class="text-muted mb-3">Lassen Sie den Inhalt dieses Blogposts automatisch verbessern:</p>
          
          <form id="improveContentForm">
            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
            <input type="hidden" name="post_id" value="<%= post.id %>">
            
            <div class="mb-3">
              <label for="focus" class="form-label">Fokus der Verbesserung</label>
              <select class="form-select" id="focus" name="focus">
                <option value="seo">SEO-Optimierung</option>
                <option value="readability">Lesbarkeit verbessern</option>
                <option value="engagement">Leser-Engagement steigern</option>
                <option value="factcheck">Faktencheck & Aktualisierung</option>
                <option value="complete">Vollständige Überarbeitung</option>
              </select>
            </div>
            
            <button type="submit" class="btn btn-primary" id="improveContentBtn">
              <i class="fas fa-magic me-2"></i> Content verbessern
            </button>
          </form>
          
          <div id="improvementResult" class="mt-4 d-none">
            <h6 class="text-muted mb-3">Verbesserungsvorschläge</h6>
            <div class="alert alert-info">
              <div class="spinner-border spinner-border-sm me-2" role="status">
                <span class="visually-hidden">Wird geladen...</span>
              </div>
              Verbesserungsvorschläge werden generiert...
            </div>
            <div id="improvementContent" class="p-3 border rounded bg-light"></div>
            <div class="mt-3">
              <button class="btn btn-success btn-sm" id="applyImprovementBtn" disabled>
                <i class="fas fa-check me-1"></i> Änderungen übernehmen
              </button>
              <button class="btn btn-outline-secondary btn-sm" id="cancelImprovementBtn">
                <i class="fas fa-times me-1"></i> Abbrechen
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Sidebar -->
    <div class="col-lg-4">
      <div class="card shadow-sm mb-4">
        <div class="card-header">
          <h5 class="mb-0">Statistik & SEO</h5>
        </div>
        <div class="card-body">
          <div class="row mb-4">
            <div class="col-6">
              <div class="text-center">
                <h3 class="fw-bold mb-1"><%= analytics.views %></h3>
                <p class="text-muted small mb-0">Ansichten</p>
              </div>
            </div>
            <div class="col-6">
              <div class="text-center">
                <h3 class="fw-bold mb-1"><%= analytics.visitors %></h3>
                <p class="text-muted small mb-0">Besucher</p>
              </div>
            </div>
          </div>
          
          <h6 class="text-muted mb-3">SEO-Informationen</h6>
          <div class="mb-3">
            <label class="form-label small text-muted">SEO-Titel</label>
            <div class="p-2 border rounded bg-light"><%= post.seoTitle || post.title %></div>
          </div>
          
          <div class="mb-3">
            <label class="form-label small text-muted">Meta-Beschreibung</label>
            <div class="p-2 border rounded bg-light"><%= post.seoDescription || post.excerpt || 'Keine Beschreibung verfügbar' %></div>
          </div>
          
          <div class="mb-3">
            <label class="form-label small text-muted">Keywords</label>
            <div class="p-2 border rounded bg-light"><%= post.seoKeywords || 'Keine Keywords verfügbar' %></div>
          </div>
        </div>
      </div>
      
      <div class="card shadow-sm mb-4">
        <div class="card-header">
          <h5 class="mb-0">Ziel-Keywords</h5>
        </div>
        <div class="card-body">
          <% if (keywords && keywords.length > 0) { %>
            <div class="table-responsive">
              <table class="table table-sm">
                <thead class="table-light">
                  <tr>
                    <th>Keyword</th>
                    <th>Suchvolumen</th>
                    <th>Ranking</th>
                  </tr>
                </thead>
                <tbody>
                  <% keywords.forEach(function(keyword) { %>
                    <tr>
                      <td><%= keyword.keyword %></td>
                      <td><%= keyword.search_volume %></td>
                      <td>
                        <% if (keyword.current_ranking) { %>
                          <span class="badge bg-<%= keyword.current_ranking <= 10 ? 'success' : (keyword.current_ranking <= 30 ? 'warning' : 'danger') %>">
                            <%= keyword.current_ranking %>
                          </span>
                        <% } else { %>
                          <span class="badge bg-secondary">n/a</span>
                        <% } %>
                      </td>
                    </tr>
                  <% }); %>
                </tbody>
              </table>
            </div>
          <% } else { %>
            <p class="text-muted">Keine Ziel-Keywords definiert</p>
            <a href="/dashboard/blog/seo" class="btn btn-sm btn-outline-primary">
              <i class="fas fa-plus me-1"></i> Keywords hinzufügen
            </a>
          <% } %>
        </div>
      </div>
      
      <div class="card shadow-sm mb-4">
        <div class="card-header">
          <h5 class="mb-0">Aktionen</h5>
        </div>
        <div class="card-body">
          <div class="d-grid gap-2">
            <a href="/dashboard/blog/<%= post.id %>/edit" class="btn btn-primary">
              <i class="fas fa-edit me-2"></i> Bearbeiten
            </a>
            <% if (post.status === 'published') { %>
              <a href="/blog/<%= post.slug %>" target="_blank" class="btn btn-success">
                <i class="fas fa-external-link-alt me-2"></i> Öffentlich anzeigen
              </a>
            <% } %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Content Improvement form
    const improveContentForm = document.getElementById('improveContentForm');
    const improvementResult = document.getElementById('improvementResult');
    const improvementContent = document.getElementById('improvementContent');
    const applyImprovementBtn = document.getElementById('applyImprovementBtn');
    const cancelImprovementBtn = document.getElementById('cancelImprovementBtn');
    
    improveContentForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      // Show the results area
      improvementResult.classList.remove('d-none');
      improvementContent.innerHTML = '';
      applyImprovementBtn.disabled = true;
      
      const formData = new FormData(improveContentForm);
      const data = {
        post_id: formData.get('post_id'),
        focus: formData.get('focus')
      };
      
      try {
        const response = await fetch('/dashboard/blog/improve-content', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'CSRF-Token': formData.get('_csrf')
          },
          body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
          improvementContent.innerHTML = result.data.content || 'Keine Verbesserungsvorschläge verfügbar.';
          applyImprovementBtn.disabled = false;
        } else {
          improvementContent.innerHTML = `<div class="alert alert-danger">Fehler: ${result.error}</div>`;
        }
      } catch (error) {
        improvementContent.innerHTML = `<div class="alert alert-danger">Fehler bei der Anfrage: ${error.message}</div>`;
      }
    });
    
    cancelImprovementBtn.addEventListener('click', function() {
      improvementResult.classList.add('d-none');
    });
  });
</script>

<%- include('../../partials/admin-footer-simple') %>