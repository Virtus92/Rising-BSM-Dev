<%- include('../../partials/admin-header') %>

<div class="dashboard-wrapper">
    <!-- Dashboard Content -->
    <div class="dashboard-content p-3 p-md-4">
      <!-- Filter & Aktionen -->
      <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 gap-3">
        <div>
          <h2 class="h4 mb-1">Kundenverwaltung</h2>
          <p class="text-muted mb-md-0">Alle Kunden von Rising BSM</p>
        </div>
        <div class="d-flex flex-wrap gap-2">
          <div class="input-group">
            <span class="input-group-text bg-white">
              <i class="fas fa-search text-muted"></i>
            </span>
            <input type="text" class="form-control" id="searchInput" placeholder="Name, Email oder Firma suchen...">
            <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">Filter</button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><h6 class="dropdown-header">Status</h6></li>
              <li><a class="dropdown-item" href="?status=aktiv">Nur aktive Kunden</a></li>
              <li><a class="dropdown-item" href="?status=inaktiv">Nur inaktive Kunden</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><h6 class="dropdown-header">Kundentyp</h6></li>
              <li><a class="dropdown-item" href="?type=privat">Privatkunden</a></li>
              <li><a class="dropdown-item" href="?type=geschaeft">Geschäftskunden</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="?sort=newest">Neueste zuerst</a></li>
              <li><a class="dropdown-item" href="?sort=name">Nach Name sortieren</a></li>
            </ul>
          </div>
          <a href="/dashboard/kunden/neu" class="btn btn-success">
            <i class="fas fa-plus me-2"></i>Neuer Kunde
          </a>
          <div class="dropdown">
            <button class="btn btn-outline-primary dropdown-toggle" type="button" id="exportDropdown" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="fas fa-download me-2"></i>Export
            </button>
            <ul class="dropdown-menu" aria-labelledby="exportDropdown">
              <li><a class="dropdown-item" href="/dashboard/kunden/export?format=csv">CSV-Export</a></li>
              <li><a class="dropdown-item" href="/dashboard/kunden/export?format=excel">Excel-Export</a></li>
              <li><a class="dropdown-item" href="/dashboard/kunden/export?format=pdf">PDF-Export</a></li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Ansichtsoptionen -->
      <ul class="nav nav-tabs mb-4" id="viewTab" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="list-tab" data-bs-toggle="tab" data-bs-target="#list-view" type="button" role="tab" aria-controls="list-view" aria-selected="true">
            <i class="fas fa-list me-2"></i>Liste
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="grid-tab" data-bs-toggle="tab" data-bs-target="#grid-view" type="button" role="tab" aria-controls="grid-view" aria-selected="false">
            <i class="fas fa-th-large me-2"></i>Karten
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="stats-tab" data-bs-toggle="tab" data-bs-target="#stats-view" type="button" role="tab" aria-controls="stats-view" aria-selected="false">
            <i class="fas fa-chart-pie me-2"></i>Statistik
          </button>
        </li>
      </ul>

      <!-- Tab-Inhalte -->
      <div class="tab-content">
        <!-- Listen-Ansicht -->
        <div class="tab-pane fade show active" id="list-view" role="tabpanel" aria-labelledby="list-tab">
          <div class="card border-0 shadow-sm">
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-hover customer-table mb-0" id="customerTable">
                  <thead class="table-light">
                    <tr>
                      <th scope="col">Name</th>
                      <th scope="col" class="d-none d-md-table-cell">Firma</th>
                      <th scope="col">Kontakt</th>
                      <th scope="col" class="d-none d-lg-table-cell">Adresse</th>
                      <th scope="col">Status</th>
                      <th scope="col">Aktionen</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% if (typeof customers !== 'undefined' && customers.length > 0) { %>
                      <% customers.forEach(function(customer) { %>
                        <tr>
                          <td>
                            <div class="d-flex align-items-center">
                              <div class="avatar-wrapper bg-light rounded-circle me-2 text-center" style="width: 32px; height: 32px; line-height: 32px;">
                                <span><%= customer.name.charAt(0) %></span>
                              </div>
                              <div>
                                <a href="/dashboard/kunden/<%= customer.id %>" class="text-decoration-none text-dark fw-medium">
                                  <%= customer.name %>
                                </a>
                                <small class="d-block d-md-none text-muted"><%= customer.firma || 'Privatkunde' %></small>
                              </div>
                            </div>
                          </td>
                          <td class="d-none d-md-table-cell"><%= customer.firma || '–' %></td>
                          <td>
                            <% if (customer.email) { %>
                              <div><a href="mailto:<%= customer.email %>" class="text-decoration-none text-primary"><i class="fas fa-envelope me-1"></i><%= customer.email %></a></div>
                            <% } %>
                            <% if (customer.telefon) { %>
                              <div><a href="tel:<%= customer.telefon %>" class="text-decoration-none text-success"><i class="fas fa-phone me-1"></i><%= customer.telefon %></a></div>
                            <% } %>
                          </td>
                          <td class="d-none d-lg-table-cell">
                            <% if (customer.adresse) { %>
                              <%= customer.adresse %><br>
                              <%= customer.plz %> <%= customer.ort %>
                            <% } else { %>
                              <span class="text-muted">–</span>
                            <% } %>
                          </td>
                          <td>
                            <span class="badge bg-<%= customer.status === 'aktiv' ? 'success' : 'secondary' %>">
                              <%= customer.status === 'aktiv' ? 'Aktiv' : 'Inaktiv' %>
                            </span>
                          </td>
                          <td>
                            <div class="btn-group btn-group-sm">
                              <a href="/dashboard/kunden/<%= customer.id %>" class="btn btn-outline-secondary">
                                <i class="fas fa-eye"></i>
                              </a>
                              <a href="/dashboard/kunden/<%= customer.id %>/edit" class="btn btn-outline-primary">
                                <i class="fas fa-edit"></i>
                              </a>
                              <button type="button" class="btn btn-outline-secondary dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">
                                <span class="visually-hidden">Dropdown</span>
                              </button>
                              <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="/dashboard/termine/neu?kunde=<%= customer.id %>"><i class="fas fa-calendar-plus me-2"></i>Termin erstellen</a></li>
                                <li><a class="dropdown-item" href="/dashboard/projekte/neu?kunde_id=<%= customer.id %>"><i class="fas fa-project-diagram me-2"></i>Projekt erstellen</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#changeStatusModal" data-id="<%= customer.id %>" data-name="<%= customer.name %>" data-status="<%= customer.status %>"><i class="fas fa-toggle-on me-2"></i>Status ändern</a></li>
                                <li><a class="dropdown-item text-danger" href="#" data-bs-toggle="modal" data-bs-target="#deleteCustomerModal" data-id="<%= customer.id %>" data-name="<%= customer.name %>"><i class="fas fa-trash-alt me-2"></i>Löschen</a></li>
                              </ul>
                            </div>
                          </td>
                        </tr>
                      <% }); %>
                    <% } else { %>
                      <tr>
                        <td colspan="6" class="text-center py-4">
                          <p class="text-muted mb-0">Keine Kunden gefunden</p>
                        </td>
                      </tr>
                    <% } %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Karten-Ansicht -->
        <div class="tab-pane fade" id="grid-view" role="tabpanel" aria-labelledby="grid-tab">
          <div class="row g-3">
            <% if (typeof customers !== 'undefined' && customers.length > 0) { %>
              <% customers.forEach(function(customer) { %>
                <div class="col-md-6 col-lg-4 col-xl-3">
                  <div class="card h-100 border-0 shadow-sm">
                    <div class="card-body">
                      <div class="d-flex align-items-center mb-3">
                        <div class="avatar-wrapper bg-light rounded-circle me-3 text-center" style="width: 48px; height: 48px; line-height: 48px;">
                          <span class="h5 mb-0"><%= customer.name.charAt(0) %></span>
                        </div>
                        <div>
                          <h5 class="card-title mb-0"><%= customer.name %></h5>
                          <p class="card-text text-muted small"><%= customer.firma || 'Privatkunde' %></p>
                        </div>
                        <div class="ms-auto">
                          <span class="badge bg-<%= customer.status === 'aktiv' ? 'success' : 'secondary' %>">
                            <%= customer.status === 'aktiv' ? 'Aktiv' : 'Inaktiv' %>
                          </span>
                        </div>
                      </div>
                      
                      <p class="card-text mb-2">
                        <i class="fas fa-envelope text-muted me-2"></i>
                        <a href="mailto:<%= customer.email %>" class="text-decoration-none"><%= customer.email %></a>
                      </p>
                      
                      <% if (customer.telefon) { %>
                        <p class="card-text mb-2">
                          <i class="fas fa-phone text-muted me-2"></i>
                          <a href="tel:<%= customer.telefon %>" class="text-decoration-none"><%= customer.telefon %></a>
                        </p>
                      <% } %>
                      
                      <% if (customer.adresse) { %>
                        <p class="card-text mb-2">
                          <i class="fas fa-map-marker-alt text-muted me-2"></i>
                          <%= customer.adresse %>, <%= customer.plz %> <%= customer.ort %>
                        </p>
                      <% } %>
                      
                      <div class="mt-3 d-flex justify-content-between">
                        <a href="/dashboard/kunden/<%= customer.id %>" class="btn btn-sm btn-outline-primary">Details</a>
                        <div class="btn-group btn-group-sm">
                          <a href="/dashboard/termine/neu?kunde=<%= customer.id %>" class="btn btn-outline-success">
                            <i class="fas fa-calendar-plus"></i>
                          </a>
                          <a href="/dashboard/projekte/neu?kunde_id=<%= customer.id %>" class="btn btn-outline-info">
                            <i class="fas fa-project-diagram"></i>
                          </a>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              <% }); %>
            <% } else { %>
              <div class="col-12">
                <div class="alert alert-info">
                  <i class="fas fa-info-circle me-2"></i> Keine Kunden gefunden.
                </div>
              </div>
            <% } %>
          </div>
        </div>

        <!-- Statistik-Ansicht -->
        <div class="tab-pane fade" id="stats-view" role="tabpanel" aria-labelledby="stats-tab">
          <div class="row g-3">
            <div class="col-md-6">
              <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                  <h5 class="card-title mb-0">Kundentypen</h5>
                </div>
                <div class="card-body">
                  <canvas id="customerTypeChart" height="250"></canvas>
                </div>
              </div>
            </div>
            
            <div class="col-md-6">
              <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                  <h5 class="card-title mb-0">Kundenstatus</h5>
                </div>
                <div class="card-body">
                  <canvas id="customerStatusChart" height="250"></canvas>
                </div>
              </div>
            </div>
            
            <div class="col-md-12">
              <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                  <h5 class="card-title mb-0">Kundenentwicklung</h5>
                </div>
                <div class="card-body">
                  <canvas id="customerGrowthChart" height="300"></canvas>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>

<!-- Löschen-Bestätigung Modal -->
<div class="modal fade" id="deleteCustomerModal" tabindex="-1" aria-labelledby="deleteCustomerModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteCustomerModalLabel">Kunde löschen</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Sind Sie sicher, dass Sie den Kunden <strong id="customerNameToDelete"></strong> löschen möchten?</p>
        <p class="text-danger">Diese Aktion kann nicht rückgängig gemacht werden.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Abbrechen</button>
        <form id="deleteCustomerForm" action="/dashboard/kunden/delete" method="POST">
          <input type="hidden" name="_csrf" value="<%= csrfToken %>">
          <input type="hidden" id="customerIdToDelete" name="id">
          <button type="submit" class="btn btn-danger">Löschen</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Status-Änderung Modal -->
<div class="modal fade" id="changeStatusModal" tabindex="-1" aria-labelledby="changeStatusModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="changeStatusModalLabel">Kundenstatus ändern</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Möchten Sie den Status des Kunden <strong id="customerNameToChange"></strong> ändern?</p>
        <form id="changeStatusForm" action="/dashboard/kunden/update-status" method="POST">
          <input type="hidden" name="_csrf" value="<%= csrfToken %>">
          <input type="hidden" id="customerIdToChange" name="id">
          
          <div class="mb-3">
            <label for="statusSelect" class="form-label">Status</label>
            <select class="form-select" id="statusSelect" name="status">
              <option value="aktiv">Aktiv</option>
              <option value="inaktiv">Inaktiv</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Abbrechen</button>
        <button type="submit" form="changeStatusForm" class="btn btn-primary">Speichern</button>
      </div>
    </div>
  </div>
</div>

<%- include('../../partials/admin-footer-simple') %>

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Alternative zu DataTables für bessere mobile Unterstützung
    const customerTable = document.getElementById('customerTable');
    if (customerTable) {
      // Hier könnten wir eine einfachere Tabellenfunktionalität implementieren
      // ohne DataTables für bessere Mobilunterstützung
      
      // Suchfunktion
      const searchInput = document.getElementById('searchInput');
      if (searchInput) {
        searchInput.addEventListener('keyup', function() {
          const searchTerm = this.value.toLowerCase();
          const rows = customerTable.querySelectorAll('tbody tr');
          
          rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(searchTerm) ? '' : 'none';
          });
        });
      }
    }
    
    // Suchfeld-Funktionalität für Serversuche
    const searchForm = document.getElementById('searchInput');
    if (searchForm) {
      searchForm.addEventListener('keyup', function(e) {
        if (e.key === 'Enter') {
          window.location.href = `/dashboard/kunden?search=${encodeURIComponent(this.value)}`;
        }
      });
    }
    
    // Lösch-Modal Funktionalität
    const deleteCustomerModal = document.getElementById('deleteCustomerModal');
    if (deleteCustomerModal) {
      deleteCustomerModal.addEventListener('show.bs.modal', function(event) {
        const button = event.relatedTarget;
        const customerId = button.getAttribute('data-id');
        const customerName = button.getAttribute('data-name');
        
        document.getElementById('customerIdToDelete').value = customerId;
        document.getElementById('customerNameToDelete').textContent = customerName;
      });
    }
    
    // Status-Änderung Modal Funktionalität
    const changeStatusModal = document.getElementById('changeStatusModal');
    if (changeStatusModal) {
      changeStatusModal.addEventListener('show.bs.modal', function(event) {
        const button = event.relatedTarget;
        const customerId = button.getAttribute('data-id');
        const customerName = button.getAttribute('data-name');
        const currentStatus = button.getAttribute('data-status');
        
        document.getElementById('customerIdToChange').value = customerId;
        document.getElementById('customerNameToChange').textContent = customerName;
        document.getElementById('statusSelect').value = currentStatus;
      });
    }
    
    // Charts für die Statistik-Ansicht initialisieren
    if (document.getElementById('stats-tab')) {
      document.getElementById('stats-tab').addEventListener('shown.bs.tab', initCharts);
    }
    
    function initCharts() {
      // Nur Charts initialisieren, wenn die Statistik-Ansicht aktiv ist
      if (!document.getElementById('stats-view').classList.contains('active')) return;
      
      // Kundentypen-Chart
      const customerTypeChart = new Chart(
        document.getElementById('customerTypeChart'),
        {
          type: 'pie',
          data: {
            labels: ['Privatkunden', 'Geschäftskunden'],
            datasets: [{
              data: [
                <%= typeof customers !== 'undefined' ? customers.filter(c => !c.kundentyp || c.kundentyp === 'privat').length : 0 %>,
                <%= typeof customers !== 'undefined' ? customers.filter(c => c.kundentyp === 'geschaeft').length : 0 %>
              ],
              backgroundColor: ['#0d6efd', '#6c757d']
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                position: 'bottom'
              }
            }
          }
        }
      );
      
      // Kundenstatus-Chart
      const customerStatusChart = new Chart(
        document.getElementById('customerStatusChart'),
        {
          type: 'pie',
          data: {
            labels: ['Aktiv', 'Inaktiv'],
            datasets: [{
              data: [
                <%= typeof customers !== 'undefined' ? customers.filter(c => !c.status || c.status === 'aktiv').length : 0 %>,
                <%= typeof customers !== 'undefined' ? customers.filter(c => c.status === 'inaktiv').length : 0 %>
              ],
              backgroundColor: ['#198754', '#dc3545']
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                position: 'bottom'
              }
            }
          }
        }
      );
      
      // Kundenentwicklung-Chart (mit Demo-Daten, diese sollten in der Produktionsumgebung vom Server kommen)
      const customerGrowthChart = new Chart(
        document.getElementById('customerGrowthChart'),
        {
          type: 'line',
          data: {
            labels: ['Jan', 'Feb', 'Mär', 'Apr', 'Mai', 'Jun'],
            datasets: [{
              label: 'Neue Kunden',
              data: [5, 8, 12, 7, 10, 15],
              borderColor: '#198754',
              backgroundColor: 'rgba(25, 135, 84, 0.1)',
              tension: 0.4,
              fill: true
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                display: false
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  precision: 0
                }
              }
            }
          }
        }
      );
    }
  });
</script>